<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Checkpoint framework - Peter Demin</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Sentence mixing puzzle game" href="08-word-mix.html" /><link rel="prev" title="Git form saver" href="06-git-form-saver.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=51f15f49" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Checkpoint framework"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Peter Demin</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#idea">Idea</a><ul>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#problem">Problem</a></li>
<li><a class="reference internal" href="#solution">Solution</a></li>
<li><a class="reference internal" href="#design">Design</a></li>
<li><a class="reference internal" href="#similarity-with-open-telemetry">Similarity with Open Telemetry</a></li>
<li><a class="reference internal" href="#similarity-with-vcr-like-test-libraries">Similarity with VCR-like test libraries</a></li>
<li><a class="reference internal" href="#contract-testing-aspect">Contract testing aspect</a></li>
</ul>
</li>
<li><a class="reference internal" href="#limitations">Limitations</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#links">Links</a></li>
</ul>
</div><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/peterdemin/peterdemin.github.io"
  data-type="github" data-user="peterdemin" data-repo="peterdemin.github.io">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    
    
      <span>peterdemin.github.io</span>
    
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div class="edit-this-page">
  <a href="https://github.com/peterdemin/peterdemin.github.io/blob/master/source/14_ideas/07-checkpoint-framework.md">Edit this page</a>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="w-full max-sm:max-w-full print:pt-6">
    
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Peter Demin</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Checkpoint framework</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <div class="copy-page-wrapper relative pb-4 lg:absolute lg:top-8 lg:right-6 xl:right-12">
  <div id="copy-page-trigger">
    <button
      type="button"
      class="js-copy px-3 py-1 inline-flex items-center gap-1"
      data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/14_ideas/07-checkpoint-framework.md.txt"
    >
      <i class="i-lucide" data-icon="copy"></i>
      <span>Copy page</span>
    </button>
    <button class="js-menu px-2 py-1" type="button" aria-label="More actions"
      aria-haspopup="menu" aria-expanded="false" aria-controls="copy-page-content">
      <i class="i-lucide chevron-down"></i>
    </button>
  </div>
  <div id="copy-page-content" role="menu" aria-orientation="vertical" aria-hidden="true">
    <div role="presentation">
      <div class="flex flex-col" role="group">
        <button class="js-copy" type="button" role="menuitem"
          data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/14_ideas/07-checkpoint-framework.md.txt">
          <span class="iconify-icon">
            <i class="i-lucide" data-icon="copy"></i>
          </span>
          <span>Copy page</span>
        </button>
        <a role="menuitem" href="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/14_ideas/07-checkpoint-framework.md.txt" target="_blank" rel="nofollow"><iconify-icon icon="bi:markdown"></iconify-icon>
            <span>View as Markdown</span></a><a role="menuitem" href="https://chatgpt.com/?hints=search&q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/14_ideas/07-checkpoint-framework.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:openai"></iconify-icon>
          <span>Open in ChatGPT</span>
        </a><a role="menuitem" href="https://claude.ai/new?q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/14_ideas/07-checkpoint-framework.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:claude"></iconify-icon>
          <span>Open in Claude</span>
        </a></div>
    </div>
  </div>
</div><article class="yue" role="main">
          <section id="checkpoint-framework">
<h1>Checkpoint framework<a class="headerlink" href="#checkpoint-framework" title="Link to this heading">¶</a></h1>
<section id="idea">
<h2>Idea<a class="headerlink" href="#idea" title="Link to this heading">¶</a></h2>
<section id="context">
<h3>Context<a class="headerlink" href="#context" title="Link to this heading">¶</a></h3>
<p>In service-oriented architecture one user action (or scenario)
involves services calling other services, creating a tree of calls.
It’s hard to tell what are the exact inputs and output for each call
without having access to the detailed logs.
And almost impossible to tell what are the possible inputs to something
sitting in between of other services just by looking at the code.</p>
<p>In well-designed architecture, each component knows very little about other.
It helps with managing complexity, and changing each component separately.
Contrary to the component, its developer needs to understand the overall system
to make the right design choices, and foresee problems.
But when looking at the code, a new team member can only infer what components know,
not what they need to know.
This knowledge lives in documentation and heads of people who built the system.</p>
</section>
<section id="problem">
<h3>Problem<a class="headerlink" href="#problem" title="Link to this heading">¶</a></h3>
<p>When looking at underdocumented untested component,
it’s sometimes hard to tell what are the example inputs and expected outputs.
Component here means an API, a class, or a function.</p>
</section>
<section id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Link to this heading">¶</a></h3>
<p>Have checkpoint annotations throughout the code, that record inputs and outputs of the components.
The checkpoint system runs more or less fixed set of scenarios, and records data as it passes through each checkpoint.
The recorded data is made available to the code as static test assets.</p>
<p>The recording is automated and regular.
Developers add new scenarios to cover new features.
When the inputs or outputs of the existing checkpoint change, the test assets are automatically updated, and the developers are alerted about the change (along with the result of the test run).</p>
</section>
<section id="design">
<h3>Design<a class="headerlink" href="#design" title="Link to this heading">¶</a></h3>
<p>The checkpoint service has two parts:</p>
<ol class="arabic simple">
<li><p>Ingestion API, that receives checkpoint data from product components, and stores them to a database.</p></li>
<li><p>User Interface to review the stored checkpoint trees and export them as test assets.</p></li>
</ol>
<p>Each language runtime that exports checkpoints has framework-specific library.
The library has a few parts:</p>
<ol class="arabic simple">
<li><p>Expose a control endpoint that enables/disables checkpointing.</p></li>
<li><p>Instrument the web framework to automatically record request and response data.</p></li>
<li><p>Instrument the client library to record outbound requests.</p></li>
<li><p>Instrument SQL framework to record raw queries and their output.</p></li>
<li><p>Provide decorator to checkpoint critical parts of the internal processing.</p></li>
<li><p>Testing-time library to load the previously recorded assets.</p></li>
</ol>
</section>
<section id="similarity-with-open-telemetry">
<h3>Similarity with Open Telemetry<a class="headerlink" href="#similarity-with-open-telemetry" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://opentelemetry.io/docs/what-is-opentelemetry/">Open Telemetry</a> provides similar functionality but with a different focus.
It captures performance metrics while having limited payload.
The purpose is to provide visibilty into the production runtime.</p>
<p>The checkpoint, on the other hand, is disabled most of the time,
only recording complete data flow in a more focused setting.
The performance is not critical during the recording sessions.</p>
</section>
<section id="similarity-with-vcr-like-test-libraries">
<h3>Similarity with VCR-like test libraries<a class="headerlink" href="#similarity-with-vcr-like-test-libraries" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://vcrpy.readthedocs.io/en/latest/">VCR.py</a> partially implements the checkpoint system,
but lacks cross-service interactions.
Focusing on the outbound calls, it helps with canning integration tests, improving reliability.
It also helps with catching a drift in external API output.
The test assets also serve as a documentation for the parts of code that a paricularly opaque in what passes through them.</p>
</section>
<section id="contract-testing-aspect">
<h3>Contract testing aspect<a class="headerlink" href="#contract-testing-aspect" title="Link to this heading">¶</a></h3>
<p>Contract testing is a related concept, that uses the recorded API calls, and allows isolated testing of cross-service interactions.
It doesn’t define the process of acquiring the test assets, and catching the drift, though.</p>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<p>After trying to apply checkpoint framework prototype to a big and messy project, I discovered a few setbacks.
The common issue for all of them was non-determinism.
The same HTTP request produces different result when repeated, or executed on the next day.
The reason for that is usage of random identifiers and timestamps.
It’s possible to record all API calls, and all database access.
But if application is generating different queries every time, mocking becomes complicated.</p>
<p>Consider the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="k">def</span><span class="w"> </span><span class="nf">good_luck_contract_testing</span><span class="p">():</span>
</span><span data-line="2">    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
</span></pre></div>
</div>
<p>Another challenge is read&amp;write persistence layer, particularly cache.
The first read returns nothing, the second read for the same key returns something because there was a write call in between.
It seems that for the persistence layer, database fixtures is a better approach.
However, generating such fixtures for each recording is a separate challenge.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">¶</a></h2>
<p>The checkpoint framework is currently on pause until I find a project where it’s useful.</p>
<p>In high-quality codebases, using checkpoint framework might not bring much value, because you can test everything without adding another layer of abstraction.
In messed up projects, adding checkpoints is a lot of work.
Probably more than ever was put into code quality.
So, might not be a good fit either.</p>
</section>
<section id="links">
<h2>Links<a class="headerlink" href="#links" title="Link to this heading">¶</a></h2>
<p>Few projects I found while researching ideas for the checkpoint framework:</p>
<ol class="arabic simple">
<li><p>https://docs.pact.io - Contract testing for HTTP and message integrations.</p></li>
<li><p>https://pypi.org/project/pytest-snapshot/ - Pytest plugin for snapshot testing.</p></li>
<li><p>https://github.com/ditrit/specimen - Yaml-based data-driven testing.</p></li>
</ol>
<p>My implementation for the checkpoint framework is open-sourced here: https://github.com/peterdemin/i8t</p>
</section>
</section>

        </article>
        <button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button>
        <div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="06-git-form-saver.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Git form saver</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="08-word-mix.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Sentence mixing puzzle game</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2022, Peter Demin</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script></body>
</html>