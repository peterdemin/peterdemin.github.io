
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Session Authentication and Single-Page Applications &#8212; Peter Demin</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=6e40e738" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=ccbe24c1"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '12_articles/40-session-auth';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="../17_notes/00_read_later.html" />
    <link rel="prev" title="Using GPIO on an industrial mini PC" href="39-mini-pc-gpio.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">Peter Demin</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Session Authentication and Single-Page Applications</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="session-authentication-and-single-page-applications">
<h1>Session Authentication and Single-Page Applications<a class="headerlink" href="#session-authentication-and-single-page-applications" title="Permalink to this heading">#</a></h1>
<p>TL;DR: Don’t use session authentication in cross-domain AJAX clients, it’s a world of pain.
Just go with <code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span> <span class="pre">&lt;token&gt;</span></code> header and be at peace.</p>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this heading">#</a></h2>
<p>This is something that I learned the hard way, during completion of a take-home assignment.
I would expect the most the full-stack developers to know this, but I haven’t found an in-depth explanation on the web.
The tech stack is Django REST Framework and React combo.
React frontend runs on a separate port in the local developer environment to support hot-reloading.
In production, frontend is served from CDN, and API is hosted on a separate subdomain.</p>
</section>
<section id="session-authentication-in-django">
<h2>Session Authentication in Django<a class="headerlink" href="#session-authentication-in-django" title="Permalink to this heading">#</a></h2>
<p>Using Django terminology, “session” in a nutshell:</p>
<ol class="arabic simple">
<li><p>When user makes the first request to the server,
Django session middleware generates a new anonymous session token.</p></li>
<li><p>The session data is available for read and write in Django views through <code class="docutils literal notranslate"><span class="pre">request.session</span></code> object.</p></li>
<li><p>Before returning response, session middleware persists session data to the cache.</p></li>
<li><p>Session middleware attaches the session token to the response as a cookie, for example: <code class="docutils literal notranslate"><span class="pre">sessionid=ovf4pg0a42vxxw7nptty5m6663h6uiky</span></code>.</p></li>
<li><p>On subsequent requests, browser sends the cookie back to the server.</p></li>
<li><p>Server fetches session data from a cache.</p></li>
</ol>
<p>(Django has other flavors, such as Database-stored session data, and signed cookies,
but they both are inferior performance-wise, and are rare in production.)</p>
<p>Session authentication basically means that <code class="docutils literal notranslate"><span class="pre">request.session[&quot;user_id&quot;]</span></code> is populated in login view.
Django provides convenient attribute <code class="docutils literal notranslate"><span class="pre">request.user</span></code> that fetches the <code class="docutils literal notranslate"><span class="pre">User</span></code> model by the <code class="docutils literal notranslate"><span class="pre">user_id</span></code>.</p>
<p>To summarise:</p>
<ol class="arabic simple">
<li><p>The Django sessions framework is entirely, and solely, cookie-based.</p></li>
<li><p>Cookie contains a session ID – not the data itself.</p></li>
</ol>
</section>
<section id="session-authentication-in-django-rest-framework">
<h2>Session Authentication in Django REST Framework<a class="headerlink" href="#session-authentication-in-django-rest-framework" title="Permalink to this heading">#</a></h2>
<p>Django REST Framework provides SessionAuthentication built on top of Django cookie-based sessions.</p>
<p>The documentation has a hint:</p>
<blockquote>
<div><p>“Session authentication is appropriate for AJAX clients that are running in the same session context as your website.”
– <a class="reference external" href="https://www.django-rest-framework.org/api-guide/authentication/">Authentication in Django REST Framework</a></p>
</div></blockquote>
<p>What “the same session context as your website” means is that the API must be served at the same domain as frontend.</p>
<p>Okay, but does it mean that it won’t work in cross-origin setup?
Great question! And a deep rabit hole…</p>
</section>
<section id="cross-origin-resource-sharing-cors">
<h2>Cross-Origin Resource Sharing (CORS)<a class="headerlink" href="#cross-origin-resource-sharing-cors" title="Permalink to this heading">#</a></h2>
<p>CORS headers allow server to configure what domains (origins) are allowed to send AJAX requests.
In absence of response header explicitly stating that this domain is approved, the browser rejects the response.</p>
<p>Thank you, browser. The confusion of this situation comes from the developer unawareness of the possible attacks.
Naive server doesn’t care about the domain. Naive frontend doesn’t care about the domain.
But intermediary browser cares a lot, and it makes sure frontend won’t sneak any request.</p>
<p>Let’s say, we serve frontend Javascript from https://www.acme.com and API is hosted at https://api.acme.com.</p>
<p>Or, in a local developer setting, Javascript is at http://localhost:3000 and API is at http://localhost:8000.
It may look like the localhost domain is the same, but the browser actually considers port number as a part of domain.</p>
<p>– Okay, okay, we set the headers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Allow</span><span class="o">-</span><span class="n">Credentials</span><span class="p">:</span> <span class="n">true</span>
<span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Allow</span><span class="o">-</span><span class="n">Origin</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">acme</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>That would do for the production. But not for local development.</p>
</section>
<section id="cross-origin-troubles-in-local-development">
<h2>Cross-Origin Troubles in Local Development<a class="headerlink" href="#cross-origin-troubles-in-local-development" title="Permalink to this heading">#</a></h2>
<p>In local environment, we have frontend and backend served from <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, but from different ports.
Let’s say <code class="docutils literal notranslate"><span class="pre">3000</span></code> for the frontend, and <code class="docutils literal notranslate"><span class="pre">8000</span></code> for the backend.</p>
<p>Session authentication kinda works if you login on the backend port directly.
The cookie is set for <code class="docutils literal notranslate"><span class="pre">localhost:8000</span></code>, and the browser passes it to server for every AJAX request coming from <code class="docutils literal notranslate"><span class="pre">localhost:3000</span></code> origin.</p>
<p>– What if you try to login through AJAX?</p>
<p>Not so much. Requests reach the server, existing cookies for the API domain are attached.
Server is happy, response arrives back to the frontend.
Except <code class="docutils literal notranslate"><span class="pre">Set-cookie</span></code> headers. Those get stripped by browser.</p>
<p>I haven’t found a definitive explanation.
Some point to presence of port number.
Some to <code class="docutils literal notranslate"><span class="pre">localhost</span></code> not having two dots, and therefore not being a proper domain name.
I don’t know exactly what is it, but I tried every solution I found on the web, and got nowhere.</p>
<p>The cookie is not set for the frontend origin.
It’s not set for API domain either.
It just goes nowhere.</p>
<p>Let me clarify:</p>
<ol class="arabic simple">
<li><p>Browser attaches existing cookies when making requests to cross-origin API.</p></li>
<li><p>API server responds back with <code class="docutils literal notranslate"><span class="pre">Set-Cookie</span></code> header.</p></li>
<li><p>No error or warning is logged in the browser, but the cookie is dropped (only for <code class="docutils literal notranslate"><span class="pre">localhost</span></code>).</p></li>
<li><p>On the next request to the API server the old cookies are sent.</p></li>
</ol>
</section>
<section id="solution-1-don-t-use-cookies">
<h2>Solution 1: Don’t Use Cookies<a class="headerlink" href="#solution-1-don-t-use-cookies" title="Permalink to this heading">#</a></h2>
<p>Don’t use cookie-based authentication when building websites with cross-origin AJAX.
Use <a class="reference external" href="https://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication">Token authentication</a> instead.
If Django REST Framework’s token authentication is too basic, try <a class="reference external" href="https://jazzband.github.io/django-rest-knox/auth/">Django REST Knox</a>.</p>
<p>– But what about CSRF?</p>
<p>Cross-site request forgery is an attack that tricks the victim into submitting a malicious request.
It works only in the context of cookie-based authentication, where browser automatically injects user’s credentials in the requests.</p>
<p>In token authentication, the credentials are sent explicitly by the client in HTTP <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header.
Hence, there’s no need protect the session from hijacking.</p>
</section>
<section id="solution-2-use-http-proxy-locally-to-make-ajax-same-origin">
<h2>Solution 2: Use HTTP Proxy Locally to Make AJAX Same-Origin<a class="headerlink" href="#solution-2-use-http-proxy-locally-to-make-ajax-same-origin" title="Permalink to this heading">#</a></h2>
<p>These troubles don’t exist in production.
When serving from a proper domain and standard HTTPS port, CORS headers work as expected.</p>
<p>For the local development, you can set up a proxy, so that HTTP requests are sent to the same-origin frontend <code class="docutils literal notranslate"><span class="pre">localhost:3000</span></code>,
and proxied to <code class="docutils literal notranslate"><span class="pre">localhost:8000</span></code> from there.
The CORS protection is implemented only in the browser, and doesn’t exist in server-to-server API calls (such as proxy).</p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="39-mini-pc-gpio.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Using GPIO on an industrial mini PC</p>
      </div>
    </a>
    <a class="right-next"
       href="../17_notes/00_read_later.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">&lt;no title&gt;</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#context">Context</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-authentication-in-django">Session Authentication in Django</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-authentication-in-django-rest-framework">Session Authentication in Django REST Framework</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-origin-troubles-in-local-development">Cross-Origin Troubles in Local Development</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-1-don-t-use-cookies">Solution 1: Don’t Use Cookies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-2-use-http-proxy-locally-to-make-ajax-same-origin">Solution 2: Use HTTP Proxy Locally to Make AJAX Same-Origin</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  
  <div class="tocsection editthispage">
    <a href="https://github.com/peterdemin/peterdemin.github.io/edit/master/source/12_articles/40-session-auth.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/12_articles/40-session-auth.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2022, Peter Demin.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>