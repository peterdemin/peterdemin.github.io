<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>FedUp - Minimal Federated CDN - Peter Demin</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Building this Website on Git Push" href="82-build-on-push.html" /><link rel="prev" title="My Radicle Journey" href="80-radicle.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=51f15f49" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="FedUp - Minimal Federated CDN"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Peter Demin</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#foreword">Foreword</a></li>
<li><a class="reference internal" href="#high-level">High-level</a></li>
<li><a class="reference internal" href="#less-high-level">Less-high level</a></li>
<li><a class="reference internal" href="#low-level">Low-level</a><ul>
<li><a class="reference internal" href="#node-initialization">Node initialization</a></li>
<li><a class="reference internal" href="#cluster-membership">Cluster membership</a></li>
<li><a class="reference internal" href="#https-certificates">HTTPS certificates</a></li>
<li><a class="reference internal" href="#wiggle-room">Wiggle room</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trust-and-security">Trust and Security</a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="w-full max-sm:max-w-full print:pt-6">
    
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Peter Demin</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">FedUp - Minimal Federated CDN</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <article class="yue" role="main">
          <section id="fedup-minimal-federated-cdn">
<h1>FedUp - Minimal Federated CDN<a class="headerlink" href="#fedup-minimal-federated-cdn" title="Link to this heading">¶</a></h1>
<section id="foreword">
<h2>Foreword<a class="headerlink" href="#foreword" title="Link to this heading">¶</a></h2>
<p>This article is more of a thought experiment in the world of federation and decentralization.
While many projects pursue social networks and instant messaging, I wanted to explore a simpler domain.
Instead of a few dozens of RPC endpoints needed to implement Authenticated Transfer Protocol, I’ll have just two actions: upload the content, and serve it publicly.</p>
<p>I call this FedUp, so it can have dual interpretation:</p>
<ol class="arabic simple">
<li><p>As a call to action, to <em>federate up</em> with your peers against the tyranny of centralized censorship and what not.</p></li>
<li><p>As a expression of frustration of <em>being fed up</em> with needless drama and incompleteness of the current implementations of Matrix, Mastodon, and BlueSky.</p></li>
</ol>
</section>
<section id="high-level">
<h2>High-level<a class="headerlink" href="#high-level" title="Link to this heading">¶</a></h2>
<p>FedUp is a federated CDN that operates within clusters of peers.
Each peer serves content for every peer in the cluster.
Cluster membership is defined by peers of the cluster.</p>
<p>User pushes their content to peer node they own, which we’ll call <em>hub</em>.
<em>Hub</em> distributes the content to all other peers, that we’ll call <em>spokes</em>.</p>
</section>
<section id="less-high-level">
<h2>Less-high level<a class="headerlink" href="#less-high-level" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Users install <code class="docutils literal notranslate"><span class="pre">fedup</span></code> binary on their machine.</p></li>
<li><p>Configure <code class="docutils literal notranslate"><span class="pre">fedup</span></code> with cluster ID, machine’s IP address, and domain name.</p></li>
<li><p>Cluster ID can be existing or a new one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fedup</span></code> joins the cluster.</p></li>
<li><p>Each machine in the cluster serves content from all other machines in the cluster.</p></li>
<li><p>Content distribution is done through direct <code class="docutils literal notranslate"><span class="pre">git+ssh</span></code> connections.</p></li>
<li><p>Each user has a private key that allows them to push changes to their own machine (hub).</p></li>
<li><p>The hub distributes the changes to all other machines (spokes).</p></li>
<li><p>Cluster membership is decided through a quorum of users of the cluster.</p></li>
<li><p>Users point their DNS record to their hub and all the spokes of the cluster.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fedup</span></code> configures each machine’s nginx to serve content for every domain from respective directory.</p></li>
</ol>
</section>
<section id="low-level">
<h2>Low-level<a class="headerlink" href="#low-level" title="Link to this heading">¶</a></h2>
<section id="node-initialization">
<h3>Node initialization<a class="headerlink" href="#node-initialization" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">fedup</span></code> initialization has following steps:</p>
<ol class="arabic simple">
<li><p>Create hub user account and generate a hub’s private key.</p></li>
<li><p>Initialize a bare git repo and configure post-receive hook that calls back to <code class="docutils literal notranslate"><span class="pre">fedup</span> <span class="pre">distribute</span></code>.</p></li>
<li><p>Add owner’s public key to authorized keys for this user.</p></li>
</ol>
</section>
<section id="cluster-membership">
<h3>Cluster membership<a class="headerlink" href="#cluster-membership" title="Link to this heading">¶</a></h3>
<p>Cluster ID is defined as a concatenation of peer domains using “<code class="docutils literal notranslate"><span class="pre">:</span></code>” as a separator,
for example: <code class="docutils literal notranslate"><span class="pre">alice.com:bob.me:peter.demin.dev</span></code>.
The order of peers doesn’t matter, neither is completeness of the list.
But at least one of the peers must be reachable.
Each domain points to public IP addresses of all peers in the cluster.</p>
<p>To join a cluster, a new node announce (through magic) its credentials to all peers.
Announcement includes:</p>
<ol class="arabic simple">
<li><p>Domain.</p></li>
<li><p>Public IP address.</p></li>
<li><p>Public Key.</p></li>
</ol>
<p>Each peer accepts the new node (through magic).</p>
<p>Accepting a peer means:</p>
<ol class="arabic simple">
<li><p>Create a new user account.</p></li>
<li><p>Initialize a bare git repo, and configure a post-receive hook that updates the HTML contents through <code class="docutils literal notranslate"><span class="pre">fedup</span> <span class="pre">deploy</span></code>.</p></li>
<li><p>Add peer’s public key to the authorized keys for this user account.</p></li>
</ol>
<p>Once accepted, hub can push content to this spoke for replication.
Domain’s owner can add a new spoke to his DNS records.</p>
</section>
<section id="https-certificates">
<h3>HTTPS certificates<a class="headerlink" href="#https-certificates" title="Link to this heading">¶</a></h3>
<p>Hub issues the certificates using DNS-01 challenge, and copies them to spokes.
If using Let’s Encrypt this is either manual, or requires a Domain provider with API access.</p>
<p>Or we figure out how to perform HTTP-01 with a short pause to distribute <code class="docutils literal notranslate"><span class="pre">.well-known/acme-challenge</span></code>.</p>
<p>Copying certificates to spokes poses some security risk, but not more than trusting spokes to serve hub’s content.</p>
</section>
<section id="wiggle-room">
<h3>Wiggle room<a class="headerlink" href="#wiggle-room" title="Link to this heading">¶</a></h3>
<p>I used specific products such as nginx, git, and Let’s Encrypt as examples, each part can be replaced.</p>
<p>It doesn’t matter if content is served through Caddy, and files copied through <code class="docutils literal notranslate"><span class="pre">rsync</span></code>.</p>
<p>Public IP addresses for SSH connections can be substituted with a VPN network.</p>
<p>The essence of this setup is that cluster users trust each other to run their peer node faithfully.
If the trust is broken, a bad node can be unfederated by deleting a directory and removing IP address from hub’s DNS records.</p>
</section>
</section>
<section id="trust-and-security">
<h2>Trust and Security<a class="headerlink" href="#trust-and-security" title="Link to this heading">¶</a></h2>
<p>If a node is compromised, the blast radius is three-fold:</p>
<ol class="arabic simple">
<li><p>Peer websites served through the IP address of the compromised node contain malicious content.</p></li>
<li><p>All nodes that replicate content from compromised node, serve malicious content for the compromised website.</p></li>
<li><p>SSL certificates of peer websites are compromised.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">fedup</span></code> can put some measures in-place to mitigate the risk.</p>
<ol class="arabic simple">
<li><p>Regular HTTPS checks of random pages hosted by peers to ensure the exact much with original.</p></li>
<li><p>Post-receive checks for malware fingerprints in the new content.</p></li>
</ol>
<p>The risk in trusting another person to host your website is the same as trusting another corporation.
Serving websites through Netlify or GitHub carries the same risk of them getting hacked and modifying the content.</p>
<p>But the FedUp attack surface is smaller, and the appeal of hacking a single website is lower.</p>
</section>
</section>

        </article>
        <button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button>
        <div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="80-radicle.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">My Radicle Journey</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="82-build-on-push.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Building this Website on Git Push</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2022, Peter Demin</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script></body>
</html>