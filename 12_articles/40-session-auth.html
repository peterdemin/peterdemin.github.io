<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Session Authentication and Single-Page Applications - Peter Demin</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Questions for a hiring manager" href="41-questions-for-hiring-manager.html" /><link rel="prev" title="Using GPIO on an industrial mini PC" href="39-mini-pc-gpio.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=51f15f49" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Session Authentication and Single-Page Applications"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Peter Demin</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#context">Context</a></li>
<li><a class="reference internal" href="#session-authentication-in-django">Session Authentication in Django</a></li>
<li><a class="reference internal" href="#session-authentication-in-django-rest-framework">Session Authentication in Django REST Framework</a></li>
<li><a class="reference internal" href="#cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</a></li>
<li><a class="reference internal" href="#cross-origin-troubles-in-local-development">Cross-Origin Troubles in Local Development</a></li>
<li><a class="reference internal" href="#solution-1-don-t-use-cookies">Solution 1: Don&#8217;t Use Cookies</a></li>
<li><a class="reference internal" href="#solution-2-use-http-proxy-locally-to-make-ajax-same-origin">Solution 2: Use HTTP Proxy Locally to Make AJAX Same-Origin</a></li>
</ul>
</div><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/peterdemin/peterdemin.github.io"
  data-type="github" data-user="peterdemin" data-repo="peterdemin.github.io">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    
    
      <span>peterdemin.github.io</span>
    
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div class="edit-this-page">
  <a href="https://github.com/peterdemin/peterdemin.github.io/blob/master/source/12_articles/40-session-auth.md">Edit this page</a>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="w-full max-sm:max-w-full print:pt-6">
    
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Peter Demin</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Session Authentication and Single-Page Applications</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <div class="copy-page-wrapper relative pb-4 lg:absolute lg:top-8 lg:right-6 xl:right-12">
  <div id="copy-page-trigger">
    <button
      type="button"
      class="js-copy px-3 py-1 inline-flex items-center gap-1"
      data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/40-session-auth.md.txt"
    >
      <i class="i-lucide" data-icon="copy"></i>
      <span>Copy page</span>
    </button>
    <button class="js-menu px-2 py-1" type="button" aria-label="More actions"
      aria-haspopup="menu" aria-expanded="false" aria-controls="copy-page-content">
      <i class="i-lucide chevron-down"></i>
    </button>
  </div>
  <div id="copy-page-content" role="menu" aria-orientation="vertical" aria-hidden="true">
    <div role="presentation">
      <div class="flex flex-col" role="group">
        <button class="js-copy" type="button" role="menuitem"
          data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/40-session-auth.md.txt">
          <span class="iconify-icon">
            <i class="i-lucide" data-icon="copy"></i>
          </span>
          <span>Copy page</span>
        </button>
        <a role="menuitem" href="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/40-session-auth.md.txt" target="_blank" rel="nofollow"><iconify-icon icon="bi:markdown"></iconify-icon>
            <span>View as Markdown</span></a><a role="menuitem" href="https://chatgpt.com/?hints=search&q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/40-session-auth.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:openai"></iconify-icon>
          <span>Open in ChatGPT</span>
        </a><a role="menuitem" href="https://claude.ai/new?q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/40-session-auth.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:claude"></iconify-icon>
          <span>Open in Claude</span>
        </a></div>
    </div>
  </div>
</div><article class="yue" role="main">
          <section id="session-authentication-and-single-page-applications">
<h1>Session Authentication and Single-Page Applications<a class="headerlink" href="#session-authentication-and-single-page-applications" title="Link to this heading">¶</a></h1>
<p>TL;DR: Don’t use session authentication in cross-domain AJAX clients, it’s a world of pain.
Just go with <code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span> <span class="pre">&lt;token&gt;</span></code> header and be at peace.</p>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Link to this heading">¶</a></h2>
<p>This is something that I learned the hard way, during completion of a take-home assignment.
I would expect the most the full-stack developers to know this, but I haven’t found an in-depth explanation on the web.
The tech stack is Django REST Framework and React combo.
React frontend runs on a separate port in the local developer environment to support hot-reloading.
In production, frontend is served from CDN, and API is hosted on a separate subdomain.</p>
</section>
<section id="session-authentication-in-django">
<h2>Session Authentication in Django<a class="headerlink" href="#session-authentication-in-django" title="Link to this heading">¶</a></h2>
<p>Using Django terminology, “session” in a nutshell:</p>
<ol class="arabic simple">
<li><p>When user makes the first request to the server,
Django session middleware generates a new anonymous session token.</p></li>
<li><p>The session data is available for read and write in Django views through <code class="docutils literal notranslate"><span class="pre">request.session</span></code> object.</p></li>
<li><p>Before returning response, session middleware persists session data to the cache.</p></li>
<li><p>Session middleware attaches the session token to the response as a cookie, for example: <code class="docutils literal notranslate"><span class="pre">sessionid=ovf4pg0a42vxxw7nptty5m6663h6uiky</span></code>.</p></li>
<li><p>On subsequent requests, browser sends the cookie back to the server.</p></li>
<li><p>Server fetches session data from a cache.</p></li>
</ol>
<p>(Django has other flavors, such as Database-stored session data, and signed cookies,
but they both are inferior performance-wise, and are rare in production.)</p>
<p>Session authentication basically means that <code class="docutils literal notranslate"><span class="pre">request.session[&quot;user_id&quot;]</span></code> is populated in login view.
Django provides convenient attribute <code class="docutils literal notranslate"><span class="pre">request.user</span></code> that fetches the <code class="docutils literal notranslate"><span class="pre">User</span></code> model by the <code class="docutils literal notranslate"><span class="pre">user_id</span></code>.</p>
<p>To summarise:</p>
<ol class="arabic simple">
<li><p>The Django sessions framework is entirely, and solely, cookie-based.</p></li>
<li><p>Cookie contains a session ID – not the data itself.</p></li>
</ol>
</section>
<section id="session-authentication-in-django-rest-framework">
<h2>Session Authentication in Django REST Framework<a class="headerlink" href="#session-authentication-in-django-rest-framework" title="Link to this heading">¶</a></h2>
<p>Django REST Framework provides SessionAuthentication built on top of Django cookie-based sessions.</p>
<p>The documentation has a hint:</p>
<blockquote>
<div><p>“Session authentication is appropriate for AJAX clients that are running in the same session context as your website.”
– <a class="reference external" href="https://www.django-rest-framework.org/api-guide/authentication/">Authentication in Django REST Framework</a></p>
</div></blockquote>
<p>What “the same session context as your website” means is that the API must be served at the same domain as frontend.</p>
<p>Okay, but does it mean that it won’t work in cross-origin setup?
Great question! And a deep rabit hole…</p>
</section>
<section id="cross-origin-resource-sharing-cors">
<h2>Cross-Origin Resource Sharing (CORS)<a class="headerlink" href="#cross-origin-resource-sharing-cors" title="Link to this heading">¶</a></h2>
<p>CORS headers allow server to configure what domains (origins) are allowed to send AJAX requests.
In absence of response header explicitly stating that this domain is approved, the browser rejects the response.</p>
<p>Thank you, browser. The confusion of this situation comes from the developer unawareness of the possible attacks.
Naive server doesn’t care about the domain. Naive frontend doesn’t care about the domain.
But intermediary browser cares a lot, and it makes sure frontend won’t sneak any request.</p>
<p>Let’s say, we serve frontend Javascript from https://www.acme.com and API is hosted at https://api.acme.com.</p>
<p>Or, in a local developer setting, Javascript is at http://localhost:3000 and API is at http://localhost:8000.
It may look like the localhost domain is the same, but the browser actually considers port number as a part of domain.</p>
<p>– Okay, okay, we set the headers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Allow</span><span class="o">-</span><span class="n">Credentials</span><span class="p">:</span> <span class="n">true</span>
</span><span data-line="2"><span class="n">Access</span><span class="o">-</span><span class="n">Control</span><span class="o">-</span><span class="n">Allow</span><span class="o">-</span><span class="n">Origin</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">acme</span><span class="o">.</span><span class="n">com</span>
</span></pre></div>
</div>
<p>That would do for the production. But not for local development.</p>
</section>
<section id="cross-origin-troubles-in-local-development">
<h2>Cross-Origin Troubles in Local Development<a class="headerlink" href="#cross-origin-troubles-in-local-development" title="Link to this heading">¶</a></h2>
<p>In local environment, we have frontend and backend served from <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, but from different ports.
Let’s say <code class="docutils literal notranslate"><span class="pre">3000</span></code> for the frontend, and <code class="docutils literal notranslate"><span class="pre">8000</span></code> for the backend.</p>
<blockquote>
<div><p><strong>PRO TIP</strong>: If your frontend is just and HTML file open from the disk as <code class="docutils literal notranslate"><span class="pre">file:///...</span></code>,
add <code class="docutils literal notranslate"><span class="pre">&quot;null&quot;</span></code> to the allowed origins on your dev server.</p>
</div></blockquote>
<p>Session authentication kinda works if you login on the backend port directly.
The cookie is set for <code class="docutils literal notranslate"><span class="pre">localhost:8000</span></code>, and the browser passes it to server for every AJAX request coming from <code class="docutils literal notranslate"><span class="pre">localhost:3000</span></code> origin.</p>
<p>– What if you try to login through AJAX?</p>
<p>Not so much. Requests reach the server, existing cookies for the API domain are attached.
Server is happy, response arrives back to the frontend.
Except <code class="docutils literal notranslate"><span class="pre">Set-cookie</span></code> headers. Those get stripped by browser.</p>
<p>I haven’t found a definitive explanation.
Some point to presence of port number.
Some to <code class="docutils literal notranslate"><span class="pre">localhost</span></code> not having two dots, and therefore not being a proper domain name.
I don’t know exactly what is it, but I tried every solution I found on the web, and got nowhere.</p>
<p>The cookie is not set for the frontend origin.
It’s not set for API domain either.
It just goes nowhere.</p>
<p>Let me clarify:</p>
<ol class="arabic simple">
<li><p>Browser attaches existing cookies when making requests to cross-origin API.</p></li>
<li><p>API server responds back with <code class="docutils literal notranslate"><span class="pre">Set-Cookie</span></code> header.</p></li>
<li><p>No error or warning is logged in the browser, but the cookie is dropped (only for <code class="docutils literal notranslate"><span class="pre">localhost</span></code>).</p></li>
<li><p>On the next request to the API server the old cookies are sent.</p></li>
</ol>
</section>
<section id="solution-1-don-t-use-cookies">
<h2>Solution 1: Don’t Use Cookies<a class="headerlink" href="#solution-1-don-t-use-cookies" title="Link to this heading">¶</a></h2>
<p>Don’t use cookie-based authentication when building websites with cross-origin AJAX.
Use <a class="reference external" href="https://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication">Token authentication</a> instead.
If Django REST Framework’s token authentication is too basic, try <a class="reference external" href="https://jazzband.github.io/django-rest-knox/auth/">Django REST Knox</a>.</p>
<p>– But what about CSRF?</p>
<p>Cross-site request forgery is an attack that tricks the victim into submitting a malicious request.
It works only in the context of cookie-based authentication, where browser automatically injects user’s credentials in the requests.</p>
<p>In token authentication, the credentials are sent explicitly by the client in HTTP <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header.
Hence, there’s no need protect the session from hijacking.</p>
</section>
<section id="solution-2-use-http-proxy-locally-to-make-ajax-same-origin">
<h2>Solution 2: Use HTTP Proxy Locally to Make AJAX Same-Origin<a class="headerlink" href="#solution-2-use-http-proxy-locally-to-make-ajax-same-origin" title="Link to this heading">¶</a></h2>
<p>These troubles don’t exist in production.
When serving from a proper domain and standard HTTPS port, CORS headers work as expected.</p>
<p>For the local development, you can set up a proxy, so that HTTP requests are sent to the same-origin frontend <code class="docutils literal notranslate"><span class="pre">localhost:3000</span></code>,
and proxied to <code class="docutils literal notranslate"><span class="pre">localhost:8000</span></code> from there.
The CORS protection is implemented only in the browser, and doesn’t exist in server-to-server API calls (such as proxy).</p>
</section>
</section>

        </article>
        <button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button>
        <div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="39-mini-pc-gpio.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Using GPIO on an industrial mini PC</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="41-questions-for-hiring-manager.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Questions for a hiring manager</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2022, Peter Demin</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script></body>
</html>