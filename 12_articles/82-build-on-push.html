<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Building this Website on Git Push - Peter Demin</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Decentralizing the Practice of Architecture at Xapo Bank" href="../17_notes/01_xapo.html" /><link rel="prev" title="FedUp - Minimal Federated CDN" href="81-fedup.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=51f15f49" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Building this Website on Git Push"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Peter Demin</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#preface">Preface</a></li>
<li><a class="reference internal" href="#virtual-machine">Virtual Machine</a></li>
<li><a class="reference internal" href="#certificate-hell">Certificate Hell</a></li>
<li><a class="reference internal" href="#infra-repo">Infra Repo</a></li>
<li><a class="reference internal" href="#certificates-and-challenges">Certificates and Challenges</a></li>
</ul>
</div><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/peterdemin/peterdemin.github.io"
  data-type="github" data-user="peterdemin" data-repo="peterdemin.github.io">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    
    
      <span>peterdemin.github.io</span>
    
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div class="edit-this-page">
  <a href="https://github.com/peterdemin/peterdemin.github.io/blob/master/source/12_articles/82-build-on-push.md">Edit this page</a>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="w-full max-sm:max-w-full print:pt-6">
    
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Peter Demin</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Building this Website on Git Push</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <div class="copy-page-wrapper relative pb-4 lg:absolute lg:top-8 lg:right-6 xl:right-12">
  <div id="copy-page-trigger">
    <button
      type="button"
      class="js-copy px-3 py-1 inline-flex items-center gap-1"
      data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt"
    >
      <i class="i-lucide" data-icon="copy"></i>
      <span>Copy page</span>
    </button>
    <button class="js-menu px-2 py-1" type="button" aria-label="More actions"
      aria-haspopup="menu" aria-expanded="false" aria-controls="copy-page-content">
      <i class="i-lucide chevron-down"></i>
    </button>
  </div>
  <div id="copy-page-content" role="menu" aria-orientation="vertical" aria-hidden="true">
    <div role="presentation">
      <div class="flex flex-col" role="group">
        <button class="js-copy" type="button" role="menuitem"
          data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt">
          <span class="iconify-icon">
            <i class="i-lucide" data-icon="copy"></i>
          </span>
          <span>Copy page</span>
        </button>
        <a role="menuitem" href="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt" target="_blank" rel="nofollow"><iconify-icon icon="bi:markdown"></iconify-icon>
            <span>View as Markdown</span></a><a role="menuitem" href="https://chatgpt.com/?hints=search&q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:openai"></iconify-icon>
          <span>Open in ChatGPT</span>
        </a><a role="menuitem" href="https://claude.ai/new?q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:claude"></iconify-icon>
          <span>Open in Claude</span>
        </a></div>
    </div>
  </div>
</div><article class="yue" role="main">
          <section id="building-this-website-on-git-push">
<h1>Building this Website on Git Push<a class="headerlink" href="#building-this-website-on-git-push" title="Link to this heading">¶</a></h1>
<section id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Link to this heading">¶</a></h2>
<p>In the spirit of my recent fascination with self-sovereignity and decentralization I will replace the fancy friendly mature reliable GitHub Pages with a hack.</p>
<blockquote>
<div><p>As a side note, I like GitHub Pages, the service democratized static website hosting and made it easily approachable to many developers.
GitHub Actions allow flexible builds outside of the default Jekyll system.
For example, I’m using a Makefile with SphinxDocs, and quiet happy with it.
And all of it is completely free.
But this article is not about GitHub Pages, this is about an <em>alternative</em>.</p>
</div></blockquote>
<p>The hack is to run a Debian VM on my home server with a git repo and post-receive hook that builds a static website.
The built artifact is then committed to another repo, which is pushed to a Cloud VPS.
I could’ve simplified the setup by building the website directly on the VPS, the problem is that the VPS is so tiny, I doubt it can handle the build process.</p>
<p>The website build process got pretty involved over the years since I’m hoarding all my petty experiments for no good reason.
The builder needs Python, graphviz, NodeJS, and customary imperial tonne of npm packages.
On the bright side, the full build process is just a single make command.</p>
<p>I’ll keep the VM running at all times and preserve the build files so it can run incrementally.
I’ll also ship the build artifact through git, which should be much faster then a complete artifact every time.</p>
<p>And I’ll have a mirror VPS to open a can of HTTPS certificate synchronization worms.</p>
</section>
<section id="virtual-machine">
<h2>Virtual Machine<a class="headerlink" href="#virtual-machine" title="Link to this heading">¶</a></h2>
<p>My favorite way of running virtual machines is with Vagrant and KVM.</p>
<p><code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># -*- mode: ruby -*-</span>
</span><span data-line="2"><span class="c1"># vi: set ft=ruby :</span>
</span><span data-line="3">
</span><span data-line="4"><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span data-line="5"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;debian/trixie64&quot;</span>
</span><span data-line="6"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span><span class="w"> </span><span class="s2">&quot;./&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;virtiofs&quot;</span>
</span><span data-line="7"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span><span class="w"> </span><span class="ss">:libvirt</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
</span><span data-line="8"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kvm&quot;</span>
</span><span data-line="9"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;qemu:///system&#39;</span>
</span><span data-line="10"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">cpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</span><span data-line="11"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2048&quot;</span>
</span><span data-line="12"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">memorybacking</span><span class="w"> </span><span class="ss">:access</span><span class="p">,</span><span class="w"> </span><span class="ss">:mode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s2">&quot;shared&quot;</span>
</span><span data-line="13"><span class="w">    </span><span class="k">end</span>
</span><span data-line="14"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;provision_builder.sh&quot;</span>
</span><span data-line="15"><span class="k">end</span>
</span></pre></div>
</div>
<p>Upon creation (<code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code>) it immediately runs the provisioning script that sets everything up.
The script is reentrant, because I had to iterate a bit to polish all the kinks.</p>
<p><code class="docutils literal notranslate"><span class="pre">provision_builder.sh</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="ch">#!/bin/bash</span>
</span><span data-line="2"><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</span><span data-line="3">
</span><span data-line="4">apt-get<span class="w"> </span>update
</span><span data-line="5">apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w">      </span><span class="se">\</span>
</span><span data-line="6"><span class="w">    </span>curl<span class="w">                </span><span class="se">\</span>
</span><span data-line="7"><span class="w">    </span>build-essential<span class="w">     </span><span class="se">\</span>
</span><span data-line="8"><span class="w">    </span>git<span class="w">                 </span><span class="se">\</span>
</span><span data-line="9"><span class="w">    </span>python3-venv<span class="w">        </span><span class="se">\</span>
</span><span data-line="10"><span class="w">    </span>python-is-python3<span class="w">   </span><span class="se">\</span>
</span><span data-line="11"><span class="w">    </span>graphviz<span class="w">            </span><span class="se">\</span>
</span><span data-line="12"><span class="w">    </span>nodejs<span class="w">              </span><span class="se">\</span>
</span><span data-line="13"><span class="w">    </span>npm<span class="w">                 </span><span class="se">\</span>
</span><span data-line="14"><span class="w">    </span>rsync
</span><span data-line="15">
</span><span data-line="16">tailscale<span class="w"> </span>status<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="17"><span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/apt/keyrings<span class="w"> </span><span class="se">\</span>
</span><span data-line="18"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg<span class="w"> </span>&gt;<span class="w"> </span>/usr/share/keyrings/tailscale-archive-keyring.gpg<span class="w"> </span><span class="se">\</span>
</span><span data-line="19"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list<span class="w"> </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/tailscale.list<span class="w"> </span><span class="se">\</span>
</span><span data-line="20"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
</span><span data-line="21"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>tailscale<span class="w"> </span><span class="se">\</span>
</span><span data-line="22"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>tailscale<span class="w"> </span>login<span class="w"> </span><span class="se">\</span>
</span><span data-line="23"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>tailscale<span class="w"> </span>up<span class="w"> </span><span class="se">\</span>
</span><span data-line="24"><span class="o">)</span>
</span><span data-line="25">
</span><span data-line="26">id<span class="w"> </span>builder<span class="w"> </span><span class="o">||</span><span class="w"> </span>useradd<span class="w"> </span>-rms<span class="w"> </span>/usr/bin/git-shell<span class="w"> </span>builder
</span><span data-line="27">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~builder/.ssh
</span><span data-line="28">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0600</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~builder/.ssh/authorized_keys<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="29"><span class="s">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDYxOnUHnt2KZ8kdjYjO/xWflaFKxXXJLv6V8/TiXgow8L+QdFmcEJ/NRdR6/LVLEwiJ5h9l26mY8XxlpVAIY43NqbhPUdBp6SoeX2tpHFQa4R1i7coO3bO1sjAVqeTmTby4iROtWZ89OEsqYnWyYco4py+sn6X+h8TDRIbrl2zYQI9IwK8O2UJTV9qT2Vy4s4fitLTeO6AI7935OsrLzXV+iaGGmhoUfpZcHZ5I9puaaTOyxuJ3q4nA0PNiZ9Lw7+TYOo73eXPA+qRrsvEy6b6x3+izyj4WX31YSklksw5CX+jjc23d7muV8cHFaoO1GkueVYyve8ncqy0dGn9CiDQudVqUyhqkF49MvWO1Hjg9SeidaKGqalh0Pv8RJquTJ8aUXcVS9GwCmYu+/JfBVcCGYKEpcwrLOt/iYa9iHCsImb/wlO08n3R+HBIF4At0Jxgd4wWM8ZhSXoA2UjCBojZwcWLPuS+S/zplFgi3stv+mkfEf9WDQo1g5bueFJ+gK8= peterdemin@MBA</span>
</span><span data-line="30"><span class="s">EOF</span>
</span><span data-line="31"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/repo.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~builder/repo.git&quot;</span>
</span><span data-line="32"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/pages.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~builder/pages.git&quot;</span>
</span><span data-line="33"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/infra.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~builder/infra.git&quot;</span>
</span><span data-line="34"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/venv<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;python3 -m venv ~builder/venv&quot;</span>
</span><span data-line="35"><span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>~builder/.ssh/id_ed25519<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -t ed25519 -f ~builder/.ssh/id_ed25519 -N &quot;&quot;&#39;</span>
</span><span data-line="36"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Copy public key to serving host:&quot;</span>
</span><span data-line="37">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -yf ~builder/.ssh/id_ed25519&#39;</span>
</span><span data-line="38"><span class="nb">echo</span>
</span><span data-line="39">
</span><span data-line="40">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global user.email &quot;builder@demin.dev&quot;&#39;</span>
</span><span data-line="41">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global user.name &quot;Builder Bot&quot;&#39;</span>
</span><span data-line="42">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global init.defaultBranch master&#39;</span>
</span><span data-line="43">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keyscan -t ed25519 demin-dev.tail13c89.ts.net &gt; ~/.ssh/known_hosts&#39;</span>
</span><span data-line="44">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keyscan -t ed25519 mirror.tail13c89.ts.net &gt;&gt; ~/.ssh/known_hosts&#39;</span>
</span><span data-line="45">
</span><span data-line="46">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~builder/worktree
</span><span data-line="47">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~builder/repo.git/hooks/post-receive<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="48"><span class="s">#!/usr/bin/env bash</span>
</span><span data-line="49"><span class="s">set -euo pipefail</span>
</span><span data-line="50">
</span><span data-line="51"><span class="s">HOME=/home/builder</span>
</span><span data-line="52"><span class="s">WORK_TREE=&quot;$HOME/worktree&quot;</span>
</span><span data-line="53"><span class="s">BRANCH=&quot;master&quot;</span>
</span><span data-line="54"><span class="s">BRANCH_REF=&quot;refs/heads/$BRANCH&quot;</span>
</span><span data-line="55">
</span><span data-line="56"><span class="s">read oldrev newrev REFNAME</span>
</span><span data-line="57"><span class="s">if [[ &quot;$REFNAME&quot; != &quot;$BRANCH_REF&quot; ]]; then</span>
</span><span data-line="58"><span class="s">  echo &quot;Ignoring push to $REFNAME (only deploys $BRANCH_REF)&quot;</span>
</span><span data-line="59"><span class="s">  exit 0</span>
</span><span data-line="60"><span class="s">fi</span>
</span><span data-line="61">
</span><span data-line="62"><span class="s">git --git-dir=&quot;$HOME/repo.git&quot; --work-tree=&quot;$WORK_TREE&quot; checkout -f $BRANCH</span>
</span><span data-line="63"><span class="s">cd &quot;$WORK_TREE&quot;</span>
</span><span data-line="64"><span class="s">. $HOME/venv/bin/activate</span>
</span><span data-line="65"><span class="s">make install lightweight compress</span>
</span><span data-line="66"><span class="s">python3 infra/cli.py builder-publish build/html</span>
</span><span data-line="67"><span class="s">EOF</span>
</span></pre></div>
</div>
<p>And that’s how I cut my website publish time from 5 minutes down to 10 seconds.</p>
<p>Setting up the serving host is similar, except that instead of building, it just needs to check out.</p>
<p><code class="docutils literal notranslate"><span class="pre">provision_pages.sh</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="ch">#!/bin/bash</span>
</span><span data-line="2"><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</span><span data-line="3">
</span><span data-line="4"><span class="nv">EMAIL</span><span class="o">=</span>peter@demin.dev
</span><span data-line="5">
</span><span data-line="6">apt-mark<span class="w"> </span>hold<span class="w"> </span>google-cloud-cli<span class="w"> </span>google-cloud-cli-anthoscli<span class="w"> </span>google-guest-agent<span class="w"> </span>google-osconfig-agent
</span><span data-line="7">
</span><span data-line="8">mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/apt/keyrings
</span><span data-line="9">curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg<span class="w"> </span>&gt;<span class="w"> </span>/usr/share/keyrings/tailscale-archive-keyring.gpg
</span><span data-line="10">curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list<span class="w"> </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/tailscale.list
</span><span data-line="11">
</span><span data-line="12">apt-get<span class="w"> </span>update
</span><span data-line="13">apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w">      </span><span class="se">\</span>
</span><span data-line="14"><span class="w">    </span>ca-certificates<span class="w">     </span><span class="se">\</span>
</span><span data-line="15"><span class="w">    </span>screen<span class="w">              </span><span class="se">\</span>
</span><span data-line="16"><span class="w">    </span>lsof<span class="w">                </span><span class="se">\</span>
</span><span data-line="17"><span class="w">    </span>python3-venv<span class="w">        </span><span class="se">\</span>
</span><span data-line="18"><span class="w">    </span>python-is-python3<span class="w">   </span><span class="se">\</span>
</span><span data-line="19"><span class="w">    </span>nginx<span class="w">               </span><span class="se">\</span>
</span><span data-line="20"><span class="w">    </span>git<span class="w">                 </span><span class="se">\</span>
</span><span data-line="21"><span class="w">    </span>age<span class="w">                 </span><span class="se">\</span>
</span><span data-line="22"><span class="w">    </span>tailscale
</span><span data-line="23">
</span><span data-line="24">tailscale<span class="w"> </span>status<span class="w"> </span><span class="o">||</span><span class="w"> </span>tailscale<span class="w"> </span>login
</span><span data-line="25">
</span><span data-line="26"><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-e<span class="w"> </span>/usr/bin/certbot<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span data-line="27"><span class="w">    </span>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>/opt/certbot/
</span><span data-line="28"><span class="w">    </span>/opt/certbot/bin/python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>certbot<span class="w"> </span>certbot-nginx
</span><span data-line="29"><span class="w">    </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/certbot/bin/certbot<span class="w"> </span>/usr/bin/certbot
</span><span data-line="30"><span class="k">fi</span>
</span><span data-line="31">
</span><span data-line="32">id<span class="w"> </span>pages<span class="w"> </span><span class="o">||</span><span class="w"> </span>useradd<span class="w"> </span>-rms<span class="w"> </span>/usr/bin/git-shell<span class="w"> </span>pages
</span><span data-line="33">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>www-data<span class="w"> </span>-m<span class="w"> </span><span class="m">0750</span><span class="w"> </span>-d<span class="w"> </span>/var/www/pages
</span><span data-line="34">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>pages<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>-d<span class="w"> </span>/var/lib/infra
</span><span data-line="35">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>pages<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~pages/.ssh
</span><span data-line="36">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>pages<span class="w"> </span>-m<span class="w"> </span><span class="m">0600</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~pages/.ssh/authorized_keys<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="37"><span class="s">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILG64GMcBIxl4rGuRum2n07Kf7dE9CUlzLl84e/TWvTM builder@trixie</span>
</span><span data-line="38"><span class="s">EOF</span>
</span><span data-line="39"><span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>~pages/.ssh/id_ed25519<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>pages<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -t ed25519 -f ~pages/.ssh/id_ed25519 -N &quot;&quot;&#39;</span>
</span><span data-line="40">
</span><span data-line="41"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Copy public key to infra/keys/ directory:&quot;</span>
</span><span data-line="42">sudo<span class="w"> </span>-u<span class="w"> </span>pages<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -yf ~pages/.ssh/id_ed25519&#39;</span>
</span><span data-line="43"><span class="nb">echo</span>
</span><span data-line="44">
</span><span data-line="45"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~pages/pages.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>pages<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~pages/pages.git&quot;</span>
</span><span data-line="46">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~pages/pages.git/hooks/post-receive<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="47"><span class="s">#!/bin/bash</span>
</span><span data-line="48"><span class="s">exec git --git-dir=&quot;/home/pages/pages.git&quot; --work-tree=&quot;/var/www/pages&quot; checkout -f master</span>
</span><span data-line="49"><span class="s">EOF</span>
</span><span data-line="50">
</span><span data-line="51"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~pages/infra.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>pages<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~pages/infra.git&quot;</span>
</span><span data-line="52">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~pages/infra.git/hooks/post-receive<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="53"><span class="s">#!/bin/bash</span>
</span><span data-line="54"><span class="s">exec git --git-dir=&quot;/home/pages/infra.git&quot; --work-tree=&quot;/var/lib/infra&quot; checkout -f master</span>
</span><span data-line="55"><span class="s">EOF</span>
</span><span data-line="56">
</span><span data-line="57">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0644</span><span class="w"> </span>/dev/stdin<span class="w"> </span>/etc/systemd/system/infra-apply.path<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="58"><span class="s">[Unit]</span>
</span><span data-line="59"><span class="s">Description=Watch infra checkout for changes</span>
</span><span data-line="60">
</span><span data-line="61"><span class="s">[Path]</span>
</span><span data-line="62"><span class="s">PathChanged=/var/lib/infra/keys/primary.pub</span>
</span><span data-line="63"><span class="s">PathChanged=/var/lib/infra/keys</span>
</span><span data-line="64"><span class="s">PathChanged=/var/lib/infra/challenges</span>
</span><span data-line="65"><span class="s">PathChanged=/var/lib/infra/certs</span>
</span><span data-line="66">
</span><span data-line="67"><span class="s">[Install]</span>
</span><span data-line="68"><span class="s">WantedBy=multi-user.target</span>
</span><span data-line="69"><span class="s">EOF</span>
</span><span data-line="70">
</span><span data-line="71">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0644</span><span class="w"> </span>/dev/stdin<span class="w"> </span>/etc/systemd/system/infra-apply.service<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="72"><span class="s">[Unit]</span>
</span><span data-line="73"><span class="s">Description=Apply infra config</span>
</span><span data-line="74">
</span><span data-line="75"><span class="s">[Service]</span>
</span><span data-line="76"><span class="s">Type=oneshot</span>
</span><span data-line="77"><span class="s">ExecStart=/usr/bin/python3 /var/lib/infra/cli.py apply</span>
</span><span data-line="78"><span class="s">EOF</span>
</span><span data-line="79">
</span><span data-line="80">systemctl<span class="w"> </span>daemon-reload
</span><span data-line="81">systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>infra-apply.path
</span><span data-line="82">
</span><span data-line="83"><span class="c1"># 8&lt; - - - - - Abort if nginx config already exist - - - - -</span>
</span><span data-line="84"><span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</span><span data-line="85">
</span><span data-line="86">rm<span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-enabled/default
</span><span data-line="87">cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="88"><span class="s">server {</span>
</span><span data-line="89"><span class="s">    server_name mirror.demin.dev;</span>
</span><span data-line="90"><span class="s">    root /var/www/pages;</span>
</span><span data-line="91"><span class="s">    index index.html index.htm;</span>
</span><span data-line="92"><span class="s">    location / {</span>
</span><span data-line="93"><span class="s">		gzip_static on;</span>
</span><span data-line="94"><span class="s">        try_files $uri $uri/ =404;</span>
</span><span data-line="95"><span class="s">    }</span>
</span><span data-line="96"><span class="s">}</span>
</span><span data-line="97"><span class="s">EOF</span>
</span><span data-line="98">ln<span class="w"> </span>-fs<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span>/etc/nginx/sites-enabled/pages
</span><span data-line="99">certbot<span class="w"> </span>--agree-tos<span class="w"> </span>--nginx<span class="w"> </span>-m<span class="w"> </span>peter@demin.dev<span class="w"> </span>--non-interactive<span class="w"> </span>-d<span class="w"> </span>mirror.demin.dev
</span><span data-line="100">systemctl<span class="w"> </span>restart<span class="w"> </span>nginx.service
</span><span data-line="101">
</span><span data-line="102">screen<span class="w"> </span>-dm<span class="w"> </span>/bin/sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;apt remove --allow-change-held-packages -y google-cloud-cli google-cloud-cli-anthoscli google-guest-agent google-osconfig-agent&quot;</span>
</span></pre></div>
</div>
<p>I added a flag to nginx to serve static precompressed gzip files to save CPU on the serving side.</p>
<p>All the heavy lifting is handled by a Python script:</p>
<p><code class="docutils literal notranslate"><span class="pre">infra/cli.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="ch">#!/usr/bin/env python3</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="4"><span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
</span><span data-line="5"><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
</span><span data-line="6"><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</span><span data-line="7"><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span data-line="8"><span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
</span><span data-line="9"><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span data-line="10"><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span data-line="11">
</span><span data-line="12"><span class="n">HERE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
</span><span data-line="13"><span class="n">INFRA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/var/lib/infra&quot;</span><span class="p">)</span>
</span><span data-line="14"><span class="n">KEYS_DIR</span> <span class="o">=</span> <span class="n">INFRA_DIR</span> <span class="o">/</span> <span class="s2">&quot;keys&quot;</span>
</span><span data-line="15"><span class="n">PRIMARY_KEY</span> <span class="o">=</span> <span class="n">KEYS_DIR</span> <span class="o">/</span> <span class="s2">&quot;primary.pub&quot;</span>
</span><span data-line="16"><span class="n">BUILDER_KEY</span> <span class="o">=</span> <span class="n">KEYS_DIR</span> <span class="o">/</span> <span class="s2">&quot;builder.pub&quot;</span>
</span><span data-line="17"><span class="n">PAGES_HOME</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/pages&quot;</span><span class="p">)</span>
</span><span data-line="18"><span class="n">AUTHORIZED_KEYS</span> <span class="o">=</span> <span class="n">PAGES_HOME</span> <span class="o">/</span> <span class="s2">&quot;.ssh&quot;</span> <span class="o">/</span> <span class="s2">&quot;authorized_keys&quot;</span>
</span><span data-line="19"><span class="n">MIRRORS_LIST</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;infra/mirrors.txt&quot;</span><span class="p">)</span>
</span><span data-line="20"><span class="n">FORWARD_LIST</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;infra/forward.txt&quot;</span><span class="p">)</span>
</span><span data-line="21"><span class="n">CHALLENGES_DIR</span> <span class="o">=</span> <span class="n">INFRA_DIR</span> <span class="o">/</span> <span class="s2">&quot;challenges&quot;</span>
</span><span data-line="22"><span class="n">WEBROOT_CHALLENGES</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/var/www/pages/.well-known/acme-challenge&quot;</span><span class="p">)</span>
</span><span data-line="23"><span class="n">CERTS_DIR</span> <span class="o">=</span> <span class="n">INFRA_DIR</span> <span class="o">/</span> <span class="s2">&quot;certs&quot;</span>
</span><span data-line="24"><span class="n">GIT_DIR</span> <span class="o">=</span> <span class="n">PAGES_HOME</span> <span class="o">/</span> <span class="s2">&quot;repo.git&quot;</span>
</span><span data-line="25"><span class="n">KNOWN_HOSTS</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.ssh/known_hosts&quot;</span>
</span><span data-line="26">
</span><span data-line="27">
</span><span data-line="28"><span class="k">def</span><span class="w"> </span><span class="nf">_ensure_root</span><span class="p">():</span>
</span><span data-line="29">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="30">        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;Must run as root.&quot;</span><span class="p">)</span>
</span><span data-line="31">
</span><span data-line="32">
</span><span data-line="33"><span class="k">class</span><span class="w"> </span><span class="nc">ApplyCommand</span><span class="p">:</span>
</span><span data-line="34">    <span class="n">_LOCAL_PUB</span> <span class="o">=</span> <span class="n">PAGES_HOME</span> <span class="o">/</span> <span class="s2">&quot;.ssh&quot;</span> <span class="o">/</span> <span class="s2">&quot;id_ed25519.pub&quot;</span>
</span><span data-line="35">
</span><span data-line="36">    <span class="k">def</span><span class="w"> </span><span class="nf">add_subparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
</span><span data-line="37">        <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;apply&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Apply infra config&quot;</span><span class="p">)</span>
</span><span data-line="38">        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
</span><span data-line="39">
</span><span data-line="40">    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span data-line="41">        <span class="k">del</span> <span class="n">args</span>
</span><span data-line="42">        <span class="n">_ensure_root</span><span class="p">()</span>
</span><span data-line="43">
</span><span data-line="44">        <span class="k">if</span> <span class="ow">not</span> <span class="n">PRIMARY_KEY</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="45">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="n">PRIMARY_KEY</span><span class="si">}</span><span class="s2">; skipping primary selection.&quot;</span><span class="p">)</span>
</span><span data-line="46">            <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="47">
</span><span data-line="48">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOCAL_PUB</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="49">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_LOCAL_PUB</span><span class="si">}</span><span class="s2">; cannot evaluate primary.&quot;</span><span class="p">)</span>
</span><span data-line="50">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="51">
</span><span data-line="52">        <span class="c1"># primary_fp = self._fingerprint(PRIMARY_KEY)</span>
</span><span data-line="53">        <span class="c1"># local_fp = self._fingerprint(self._LOCAL_PUB)</span>
</span><span data-line="54">        <span class="c1"># if primary_fp == local_fp:</span>
</span><span data-line="55">        <span class="c1">#     subprocess.check_call(</span>
</span><span data-line="56">        <span class="c1">#         [&quot;systemctl&quot;, &quot;enable&quot;, &quot;--now&quot;, &quot;certbot.timer&quot;]</span>
</span><span data-line="57">        <span class="c1">#     )</span>
</span><span data-line="58">        <span class="c1"># else:</span>
</span><span data-line="59">        <span class="c1">#     subprocess.check_call(</span>
</span><span data-line="60">        <span class="c1">#         [&quot;systemctl&quot;, &quot;disable&quot;, &quot;--now&quot;, &quot;certbot.timer&quot;]</span>
</span><span data-line="61">        <span class="c1">#     )</span>
</span><span data-line="62">
</span><span data-line="63">        <span class="k">if</span> <span class="n">KEYS_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="64">            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="65">            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">BUILDER_KEY</span><span class="p">,</span> <span class="n">PRIMARY_KEY</span><span class="p">):</span>
</span><span data-line="66">                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="67">                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span data-line="68">            <span class="k">if</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
</span><span data-line="69">                <span class="nb">print</span><span class="p">(</span>
</span><span data-line="70">                    <span class="s2">&quot;No builder/primary keys found in infra/keys; &quot;</span>
</span><span data-line="71">                    <span class="s2">&quot;authorized_keys not updated.&quot;</span>
</span><span data-line="72">                <span class="p">)</span>
</span><span data-line="73">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="74">                <span class="bp">self</span><span class="o">.</span><span class="n">_write_authorized_keys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span><span data-line="75">
</span><span data-line="76">        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_challenges</span><span class="p">()</span>
</span><span data-line="77">        <span class="bp">self</span><span class="o">.</span><span class="n">_sync_certs</span><span class="p">()</span>
</span><span data-line="78">        <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="79">
</span><span data-line="80">    <span class="k">def</span><span class="w"> </span><span class="nf">_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="81">        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span><span data-line="82">            <span class="p">[</span><span class="s2">&quot;ssh-keygen&quot;</span><span class="p">,</span> <span class="s2">&quot;-lf&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)],</span>
</span><span data-line="83">            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="84">        <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="85">
</span><span data-line="86">    <span class="k">def</span><span class="w"> </span><span class="nf">_write_authorized_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
</span><span data-line="87">        <span class="n">AUTHORIZED_KEYS</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span>
</span><span data-line="88">            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
</span><span data-line="89">        <span class="p">)</span>
</span><span data-line="90">        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">AUTHORIZED_KEYS</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
</span><span data-line="91">        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;chown&quot;</span><span class="p">,</span> <span class="s2">&quot;pages:pages&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">AUTHORIZED_KEYS</span><span class="p">)])</span>
</span><span data-line="92">
</span><span data-line="93">    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_challenges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="94">        <span class="k">if</span> <span class="ow">not</span> <span class="n">CHALLENGES_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="95">            <span class="k">return</span>
</span><span data-line="96">        <span class="n">WEBROOT_CHALLENGES</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="97">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">WEBROOT_CHALLENGES</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
</span><span data-line="98">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span data-line="99">                <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span data-line="100">        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">CHALLENGES_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
</span><span data-line="101">            <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span data-line="102">                <span class="k">continue</span>
</span><span data-line="103">            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">WEBROOT_CHALLENGES</span> <span class="o">/</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="104">
</span><span data-line="105">    <span class="k">def</span><span class="w"> </span><span class="nf">_sync_certs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="106">        <span class="k">if</span> <span class="ow">not</span> <span class="n">CERTS_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="107">            <span class="k">return</span>
</span><span data-line="108">        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="109">        <span class="n">key_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/pages/.ssh/id_ed25519&quot;</span><span class="p">)</span>
</span><span data-line="110">        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="111">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing decryption key: </span><span class="si">{</span><span class="n">key_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="112">            <span class="k">return</span>
</span><span data-line="113">        <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">CERTS_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.tar.age&quot;</span><span class="p">):</span>
</span><span data-line="114">            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
</span><span data-line="115">                <span class="n">out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span> <span class="o">/</span> <span class="n">enc</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.age&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="116">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="117">                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="118">                        <span class="p">[</span>
</span><span data-line="119">                            <span class="s2">&quot;age&quot;</span><span class="p">,</span>
</span><span data-line="120">                            <span class="s2">&quot;--decrypt&quot;</span><span class="p">,</span>
</span><span data-line="121">                            <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
</span><span data-line="122">                            <span class="nb">str</span><span class="p">(</span><span class="n">key_path</span><span class="p">),</span>
</span><span data-line="123">                            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
</span><span data-line="124">                            <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">),</span>
</span><span data-line="125">                            <span class="nb">str</span><span class="p">(</span><span class="n">enc</span><span class="p">),</span>
</span><span data-line="126">                        <span class="p">],</span>
</span><span data-line="127">                        <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="128">                    <span class="p">)</span>
</span><span data-line="129">                    <span class="bp">self</span><span class="o">.</span><span class="n">_install_certs_from_tar</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span data-line="130">                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="131">                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
</span><span data-line="132">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decrypt cert bundle: </span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="133">                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span data-line="134">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to install certs from </span><span class="si">{</span><span class="n">enc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="135">        <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
</span><span data-line="136">            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;systemctl&quot;</span><span class="p">,</span> <span class="s2">&quot;reload&quot;</span><span class="p">,</span> <span class="s2">&quot;nginx&quot;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="137">
</span><span data-line="138">    <span class="k">def</span><span class="w"> </span><span class="nf">_install_certs_from_tar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="139">        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
</span><span data-line="140">            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_path</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
</span><span data-line="141">                <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
</span><span data-line="142">            <span class="n">tmp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
</span><span data-line="143">            <span class="n">domain</span> <span class="o">=</span> <span class="n">tar_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tar&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span data-line="144">            <span class="n">live_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/etc/letsencrypt/live&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">domain</span>
</span><span data-line="145">            <span class="n">live_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="146">            <span class="n">fullchain</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="s2">&quot;fullchain.pem&quot;</span>
</span><span data-line="147">            <span class="n">privkey</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="s2">&quot;privkey.pem&quot;</span>
</span><span data-line="148">            <span class="k">if</span> <span class="ow">not</span> <span class="n">fullchain</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">privkey</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="149">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Missing cert files in archive.&quot;</span><span class="p">)</span>
</span><span data-line="150">            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fullchain</span><span class="p">,</span> <span class="n">live_dir</span> <span class="o">/</span> <span class="s2">&quot;fullchain.pem&quot;</span><span class="p">)</span>
</span><span data-line="151">            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">privkey</span><span class="p">,</span> <span class="n">live_dir</span> <span class="o">/</span> <span class="s2">&quot;privkey.pem&quot;</span><span class="p">)</span>
</span><span data-line="152">            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">live_dir</span> <span class="o">/</span> <span class="s2">&quot;fullchain.pem&quot;</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>
</span><span data-line="153">            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">live_dir</span> <span class="o">/</span> <span class="s2">&quot;privkey.pem&quot;</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
</span><span data-line="154">
</span><span data-line="155">
</span><span data-line="156"><span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">:</span>
</span><span data-line="157">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="158">        <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">c</span>
</span><span data-line="159">        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span data-line="160">        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span data-line="161">
</span><span data-line="162">    <span class="k">def</span><span class="w"> </span><span class="nf">runuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Command&quot;</span><span class="p">:</span>
</span><span data-line="163">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="164">            <span class="o">*</span><span class="p">((</span><span class="s2">&quot;runuser&quot;</span><span class="p">,</span> <span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">),</span>
</span><span data-line="165">            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
</span><span data-line="166">            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">,</span>
</span><span data-line="167">        <span class="p">)</span>
</span><span data-line="168">
</span><span data-line="169">    <span class="k">def</span><span class="w"> </span><span class="nf">subcommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Command&quot;</span><span class="p">:</span>
</span><span data-line="170">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
</span><span data-line="171">            <span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span>
</span><span data-line="172">            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
</span><span data-line="173">            <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span><span class="p">),</span>
</span><span data-line="174">        <span class="p">)</span>
</span><span data-line="175">
</span><span data-line="176">    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span data-line="177">        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="178">        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span><span class="p">))</span>
</span><span data-line="179">
</span><span data-line="180">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="181">        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="182">        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span><span class="p">))</span>
</span><span data-line="183">
</span><span data-line="184">    <span class="k">def</span><span class="w"> </span><span class="nf">check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="185">        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span data-line="186">        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span><span data-line="187">            <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span>
</span><span data-line="188">            <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">|</span> <span class="n">kwargs</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span>
</span><span data-line="189">        <span class="p">)</span>
</span><span data-line="190">
</span><span data-line="191">    <span class="k">def</span><span class="w"> </span><span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="192">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
</span><span data-line="193">            <span class="nb">print</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">c</span><span class="p">)),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span data-line="194">
</span><span data-line="195">
</span><span data-line="196"><span class="k">class</span><span class="w"> </span><span class="nc">Mirror</span><span class="p">:</span>
</span><span data-line="197">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infra</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">HERE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="198">        <span class="bp">self</span><span class="o">.</span><span class="n">_infra</span> <span class="o">=</span> <span class="n">infra</span>
</span><span data-line="199">
</span><span data-line="200">    <span class="k">def</span><span class="w"> </span><span class="nf">all_mirrors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="201">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_remotes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_infra</span> <span class="o">/</span> <span class="s2">&quot;mirrors.txt&quot;</span><span class="p">)</span>
</span><span data-line="202">
</span><span data-line="203">    <span class="k">def</span><span class="w"> </span><span class="nf">primary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span data-line="204">        <span class="n">primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_comment</span><span class="p">()</span>
</span><span data-line="205">        <span class="n">mirrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_mirrors</span><span class="p">()</span>
</span><span data-line="206">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="207">            <span class="k">if</span> <span class="n">remote</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">primary</span><span class="p">):</span>
</span><span data-line="208">                <span class="k">return</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span>
</span><span data-line="209">        <span class="k">return</span> <span class="n">mirrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="210">
</span><span data-line="211">    <span class="k">def</span><span class="w"> </span><span class="nf">non_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="212">        <span class="n">primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_comment</span><span class="p">()</span>
</span><span data-line="213">        <span class="n">mirrors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_mirrors</span><span class="p">()</span>
</span><span data-line="214">        <span class="n">primary_idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="215">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mirrors</span><span class="p">):</span>
</span><span data-line="216">            <span class="k">if</span> <span class="n">remote</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">primary</span><span class="p">):</span>
</span><span data-line="217">                <span class="n">primary_idx</span> <span class="o">=</span> <span class="n">i</span>
</span><span data-line="218">                <span class="k">break</span>
</span><span data-line="219">        <span class="k">return</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mirrors</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">primary_idx</span><span class="p">]</span>
</span><span data-line="220">
</span><span data-line="221">    <span class="k">def</span><span class="w"> </span><span class="nf">_primary_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span data-line="222">        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_infra</span> <span class="o">/</span> <span class="s2">&quot;keys/primary.pub&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="223">
</span><span data-line="224">    <span class="k">def</span><span class="w"> </span><span class="nf">forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="225">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_remotes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_infra</span> <span class="o">/</span> <span class="s2">&quot;forward.txt&quot;</span><span class="p">)</span>
</span><span data-line="226">
</span><span data-line="227">    <span class="k">def</span><span class="w"> </span><span class="nf">_load_remotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span data-line="228">        <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="229">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
</span><span data-line="230">            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="231">            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
</span><span data-line="232">                <span class="n">remote</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</span><span data-line="233">                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">or</span> <span class="s2">&quot;master&quot;</span><span class="p">))</span>
</span><span data-line="234">        <span class="k">return</span> <span class="n">result</span>
</span><span data-line="235">
</span><span data-line="236">
</span><span data-line="237"><span class="k">class</span><span class="w"> </span><span class="nc">BuilderPublishCommand</span><span class="p">:</span>
</span><span data-line="238">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="239">        <span class="n">bare_git</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;--git-dir&quot;</span><span class="p">)</span>
</span><span data-line="240">        <span class="bp">self</span><span class="o">.</span><span class="n">_pages_git</span> <span class="o">=</span> <span class="n">bare_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;pages.git&quot;</span><span class="p">)</span>
</span><span data-line="241">        <span class="bp">self</span><span class="o">.</span><span class="n">_infra_git</span> <span class="o">=</span> <span class="n">bare_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;infra.git&quot;</span><span class="p">)</span>
</span><span data-line="242">        <span class="bp">self</span><span class="o">.</span><span class="n">_source_git</span> <span class="o">=</span> <span class="n">bare_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;repo.git&quot;</span><span class="p">)</span>
</span><span data-line="243">
</span><span data-line="244">    <span class="k">def</span><span class="w"> </span><span class="nf">add_subparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
</span><span data-line="245">        <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;builder-publish&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Push to mirrors&quot;</span><span class="p">)</span>
</span><span data-line="246">        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory with content to publish&quot;</span><span class="p">)</span>
</span><span data-line="247">        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
</span><span data-line="248">
</span><span data-line="249">    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span data-line="250"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="251"><span class="sd">        Publishes content and infra changes to all mirrors.</span>
</span><span data-line="252">
</span><span data-line="253"><span class="sd">        Executed from the worktree directory of source repo.</span>
</span><span data-line="254"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="255">        <span class="n">mirror</span> <span class="o">=</span> <span class="n">Mirror</span><span class="p">()</span>
</span><span data-line="256">        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">mirror</span><span class="o">.</span><span class="n">all_mirrors</span><span class="p">()</span>
</span><span data-line="257">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="258">            <span class="bp">self</span><span class="o">.</span><span class="n">_add_host_key</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
</span><span data-line="259">        <span class="bp">self</span><span class="o">.</span><span class="n">_push_content</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">)</span>
</span><span data-line="260">        <span class="n">infra_mirrors</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="261">            <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:pages.git&quot;</span><span class="p">,</span> <span class="s2">&quot;:infra.git&quot;</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
</span><span data-line="262">            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mirrors</span>
</span><span data-line="263">            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:pages.git&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span>
</span><span data-line="264">        <span class="p">]</span>
</span><span data-line="265">        <span class="bp">self</span><span class="o">.</span><span class="n">_push_infra</span><span class="p">(</span><span class="n">infra_mirrors</span><span class="p">)</span>
</span><span data-line="266">        <span class="bp">self</span><span class="o">.</span><span class="n">_push_source</span><span class="p">(</span><span class="n">mirror</span><span class="o">.</span><span class="n">forwards</span><span class="p">())</span>
</span><span data-line="267">        <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="268">
</span><span data-line="269">    <span class="k">def</span><span class="w"> </span><span class="nf">_push_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="270">        <span class="n">git</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span data-line="271">        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;-A&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span data-line="272">        <span class="n">git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;build pages&quot;</span><span class="p">)</span>
</span><span data-line="273">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="274">            <span class="bp">self</span><span class="o">.</span><span class="n">_pages_git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;+master:</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="275">
</span><span data-line="276">    <span class="k">def</span><span class="w"> </span><span class="nf">_push_infra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="277">        <span class="n">git</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infra_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="s2">&quot;infra&quot;</span><span class="p">,</span> <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span data-line="278">        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;-A&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span data-line="279">        <span class="n">git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;infra&quot;</span><span class="p">)</span>
</span><span data-line="280">        <span class="n">p_remote</span><span class="p">,</span> <span class="n">p_branch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_primary</span><span class="p">(</span><span class="n">mirrors</span><span class="p">)</span>
</span><span data-line="281">        <span class="n">git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;pull&quot;</span><span class="p">,</span> <span class="s2">&quot;--rebase&quot;</span><span class="p">,</span> <span class="n">p_remote</span><span class="p">,</span> <span class="n">p_branch</span><span class="p">)</span>
</span><span data-line="282">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="283">            <span class="bp">self</span><span class="o">.</span><span class="n">_infra_git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
</span><span data-line="284">
</span><span data-line="285">    <span class="k">def</span><span class="w"> </span><span class="nf">_push_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="286">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="287">            <span class="bp">self</span><span class="o">.</span><span class="n">_add_host_key</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
</span><span data-line="288">            <span class="bp">self</span><span class="o">.</span><span class="n">_source_git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;+master:</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="289">
</span><span data-line="290">    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_primary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span data-line="291">        <span class="n">comment</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;infra/keys/primary.pub&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="292">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
</span><span data-line="293">            <span class="k">if</span> <span class="n">remote</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
</span><span data-line="294">                <span class="k">return</span> <span class="n">remote</span><span class="p">,</span> <span class="n">branch</span>
</span><span data-line="295">        <span class="k">return</span> <span class="n">mirrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="296">
</span><span data-line="297">    <span class="k">def</span><span class="w"> </span><span class="nf">_add_host_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="298">        <span class="n">host</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="299">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">KNOWN_HOSTS</span><span class="o">.</span><span class="n">open</span><span class="p">():</span>
</span><span data-line="300">            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
</span><span data-line="301">                <span class="k">return</span>
</span><span data-line="302">        <span class="n">keyscan</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;ssh-keyscan&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;ed25519&quot;</span><span class="p">)</span>
</span><span data-line="303">        <span class="k">with</span> <span class="n">KNOWN_HOSTS</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;at&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
</span><span data-line="304">            <span class="n">fobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">keyscan</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="305">
</span><span data-line="306">
</span><span data-line="307"><span class="k">class</span><span class="w"> </span><span class="nc">DistributeChallengeCommand</span><span class="p">:</span>
</span><span data-line="308">    <span class="k">def</span><span class="w"> </span><span class="nf">add_subparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
</span><span data-line="309">        <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
</span><span data-line="310">            <span class="s2">&quot;distribute-challenge&quot;</span><span class="p">,</span>
</span><span data-line="311">            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Write ACME challenge and push infra branch to mirrors&quot;</span><span class="p">,</span>
</span><span data-line="312">        <span class="p">)</span>
</span><span data-line="313">        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--token&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="314">        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--validation&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="315">        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
</span><span data-line="316">
</span><span data-line="317">    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span data-line="318">        <span class="n">_ensure_root</span><span class="p">()</span>
</span><span data-line="319">
</span><span data-line="320">        <span class="n">token</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="321">        <span class="n">validation</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="322">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">validation</span><span class="p">:</span>
</span><span data-line="323">            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Token and validation must be non-empty.&quot;</span><span class="p">)</span>
</span><span data-line="324">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="325">
</span><span data-line="326">        <span class="n">CHALLENGES_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="327">        <span class="n">WEBROOT_CHALLENGES</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="328">
</span><span data-line="329">        <span class="p">(</span><span class="n">CHALLENGES_DIR</span> <span class="o">/</span> <span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">validation</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span data-line="330">        <span class="p">(</span><span class="n">WEBROOT_CHALLENGES</span> <span class="o">/</span> <span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">validation</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span data-line="331">        <span class="n">git</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span> <span class="n">GIT_DIR</span><span class="p">,</span> <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span> <span class="n">INFRA_DIR</span><span class="p">]</span>
</span><span data-line="332">
</span><span data-line="333">        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">git</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;checkout&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">])</span>
</span><span data-line="334">        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">git</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;infra/challenges&quot;</span><span class="p">])</span>
</span><span data-line="335">        <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">git</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;--cached&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="336">            <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="337">        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">git</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;Add challenge&quot;</span><span class="p">])</span>
</span><span data-line="338">
</span><span data-line="339">        <span class="k">if</span> <span class="n">MIRRORS_LIST</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="340">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">MIRRORS_LIST</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span data-line="341">                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="342">                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
</span><span data-line="343">                    <span class="k">continue</span>
</span><span data-line="344">                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span>
</span><span data-line="345">                    <span class="p">[</span>
</span><span data-line="346">                        <span class="s2">&quot;runuser&quot;</span><span class="p">,</span>
</span><span data-line="347">                        <span class="s2">&quot;-u&quot;</span><span class="p">,</span>
</span><span data-line="348">                        <span class="s2">&quot;pages&quot;</span><span class="p">,</span>
</span><span data-line="349">                        <span class="s2">&quot;--&quot;</span><span class="p">,</span>
</span><span data-line="350">                        <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="351">                        <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="352">                        <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="353">                        <span class="s2">&quot;push&quot;</span><span class="p">,</span>
</span><span data-line="354">                        <span class="n">line</span><span class="p">,</span>
</span><span data-line="355">                        <span class="s2">&quot;master&quot;</span><span class="p">,</span>
</span><span data-line="356">                    <span class="p">],</span>
</span><span data-line="357">                <span class="p">)</span>
</span><span data-line="358">
</span><span data-line="359">        <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="360">
</span><span data-line="361">
</span><span data-line="362"><span class="k">class</span><span class="w"> </span><span class="nc">CleanupChallengeCommand</span><span class="p">:</span>
</span><span data-line="363">    <span class="k">def</span><span class="w"> </span><span class="nf">add_subparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
</span><span data-line="364">        <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
</span><span data-line="365">            <span class="s2">&quot;cleanup-challenge&quot;</span><span class="p">,</span>
</span><span data-line="366">            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Remove ACME challenge and push infra branch to mirrors&quot;</span><span class="p">,</span>
</span><span data-line="367">        <span class="p">)</span>
</span><span data-line="368">        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--token&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="369">        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
</span><span data-line="370">
</span><span data-line="371">    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span data-line="372">        <span class="n">_ensure_root</span><span class="p">()</span>
</span><span data-line="373">
</span><span data-line="374">        <span class="n">token</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="375">        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span><span data-line="376">            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Token must be non-empty.&quot;</span><span class="p">)</span>
</span><span data-line="377">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="378">
</span><span data-line="379">        <span class="n">challenge</span> <span class="o">=</span> <span class="n">CHALLENGES_DIR</span> <span class="o">/</span> <span class="n">token</span>
</span><span data-line="380">        <span class="n">web_challenge</span> <span class="o">=</span> <span class="n">WEBROOT_CHALLENGES</span> <span class="o">/</span> <span class="n">token</span>
</span><span data-line="381">        <span class="k">if</span> <span class="n">challenge</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="382">            <span class="n">challenge</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span data-line="383">        <span class="k">if</span> <span class="n">web_challenge</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="384">            <span class="n">web_challenge</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span data-line="385">
</span><span data-line="386">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="387">            <span class="p">[</span>
</span><span data-line="388">                <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="389">                <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="390">                <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="391">                <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span>
</span><span data-line="392">                <span class="n">INFRA_DIR</span><span class="p">,</span>
</span><span data-line="393">                <span class="s2">&quot;checkout&quot;</span><span class="p">,</span>
</span><span data-line="394">                <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
</span><span data-line="395">                <span class="s2">&quot;master&quot;</span><span class="p">,</span>
</span><span data-line="396">            <span class="p">],</span>
</span><span data-line="397">            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="398">        <span class="p">)</span>
</span><span data-line="399">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="400">            <span class="p">[</span>
</span><span data-line="401">                <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="402">                <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="403">                <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="404">                <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span>
</span><span data-line="405">                <span class="n">INFRA_DIR</span><span class="p">,</span>
</span><span data-line="406">                <span class="s2">&quot;add&quot;</span><span class="p">,</span>
</span><span data-line="407">                <span class="s2">&quot;infra/challenges&quot;</span><span class="p">,</span>
</span><span data-line="408">            <span class="p">],</span>
</span><span data-line="409">            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="410">        <span class="p">)</span>
</span><span data-line="411">        <span class="n">diff</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="412">            <span class="p">[</span>
</span><span data-line="413">                <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="414">                <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="415">                <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="416">                <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span>
</span><span data-line="417">                <span class="n">INFRA_DIR</span><span class="p">,</span>
</span><span data-line="418">                <span class="s2">&quot;diff&quot;</span><span class="p">,</span>
</span><span data-line="419">                <span class="s2">&quot;--cached&quot;</span><span class="p">,</span>
</span><span data-line="420">                <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span>
</span><span data-line="421">            <span class="p">]</span>
</span><span data-line="422">        <span class="p">)</span>
</span><span data-line="423">        <span class="k">if</span> <span class="n">diff</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="424">            <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="425">        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="426">            <span class="p">[</span>
</span><span data-line="427">                <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="428">                <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="429">                <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="430">                <span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span>
</span><span data-line="431">                <span class="n">INFRA_DIR</span><span class="p">,</span>
</span><span data-line="432">                <span class="s2">&quot;commit&quot;</span><span class="p">,</span>
</span><span data-line="433">                <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
</span><span data-line="434">                <span class="sa">f</span><span class="s2">&quot;Remove ACME challenge </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span data-line="435">            <span class="p">],</span>
</span><span data-line="436">            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="437">        <span class="p">)</span>
</span><span data-line="438">
</span><span data-line="439">        <span class="k">if</span> <span class="n">MIRRORS_LIST</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="440">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">MIRRORS_LIST</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span data-line="441">                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="442">                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
</span><span data-line="443">                    <span class="k">continue</span>
</span><span data-line="444">                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span data-line="445">                    <span class="p">[</span>
</span><span data-line="446">                        <span class="s2">&quot;runuser&quot;</span><span class="p">,</span>
</span><span data-line="447">                        <span class="s2">&quot;-u&quot;</span><span class="p">,</span>
</span><span data-line="448">                        <span class="s2">&quot;pages&quot;</span><span class="p">,</span>
</span><span data-line="449">                        <span class="s2">&quot;--&quot;</span><span class="p">,</span>
</span><span data-line="450">                        <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span data-line="451">                        <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span>
</span><span data-line="452">                        <span class="n">GIT_DIR</span><span class="p">,</span>
</span><span data-line="453">                        <span class="s2">&quot;push&quot;</span><span class="p">,</span>
</span><span data-line="454">                        <span class="n">line</span><span class="p">,</span>
</span><span data-line="455">                        <span class="s2">&quot;master&quot;</span><span class="p">,</span>
</span><span data-line="456">                    <span class="p">],</span>
</span><span data-line="457">                    <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="458">                <span class="p">)</span>
</span><span data-line="459">
</span><span data-line="460">        <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="461">
</span><span data-line="462">
</span><span data-line="463"><span class="k">class</span><span class="w"> </span><span class="nc">DistributeCertsCommand</span><span class="p">:</span>
</span><span data-line="464">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="465">        <span class="bp">self</span><span class="o">.</span><span class="n">_live</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/etc/letsencrypt/live&quot;</span><span class="p">)</span>
</span><span data-line="466">
</span><span data-line="467">    <span class="k">def</span><span class="w"> </span><span class="nf">add_subparser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
</span><span data-line="468">        <span class="n">p</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
</span><span data-line="469">            <span class="s2">&quot;distribute-certs&quot;</span><span class="p">,</span>
</span><span data-line="470">            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Encrypt certs to mirrors and push infra branch&quot;</span><span class="p">,</span>
</span><span data-line="471">        <span class="p">)</span>
</span><span data-line="472">        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--domain&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="473">        <span class="n">p</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle</span><span class="p">)</span>
</span><span data-line="474">
</span><span data-line="475">    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span data-line="476">        <span class="n">_ensure_root</span><span class="p">()</span>
</span><span data-line="477">
</span><span data-line="478">        <span class="n">domain</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span data-line="479">        <span class="n">fullchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live</span> <span class="o">/</span> <span class="n">domain</span> <span class="o">/</span> <span class="s2">&quot;fullchain.pem&quot;</span>
</span><span data-line="480">        <span class="n">privkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live</span> <span class="o">/</span> <span class="n">domain</span> <span class="o">/</span> <span class="s2">&quot;privkey.pem&quot;</span>
</span><span data-line="481">
</span><span data-line="482">        <span class="k">if</span> <span class="ow">not</span> <span class="n">fullchain</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="483">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing fullchain at </span><span class="si">{</span><span class="n">fullchain</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span data-line="484">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="485">        <span class="k">if</span> <span class="ow">not</span> <span class="n">privkey</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span data-line="486">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing privkey at </span><span class="si">{</span><span class="n">privkey</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span data-line="487">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="488">
</span><span data-line="489">        <span class="n">recipients</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="490">        <span class="k">for</span> <span class="n">pub</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">KEYS_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pub&quot;</span><span class="p">)):</span>
</span><span data-line="491">            <span class="k">if</span> <span class="n">pub</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;primary.pub&quot;</span><span class="p">,</span> <span class="s2">&quot;builder.pub&quot;</span><span class="p">):</span>
</span><span data-line="492">                <span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pub</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span data-line="493">        <span class="k">if</span> <span class="ow">not</span> <span class="n">recipients</span><span class="p">:</span>
</span><span data-line="494">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No recipients found in </span><span class="si">{</span><span class="n">KEYS_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="495">            <span class="k">return</span> <span class="mi">1</span>
</span><span data-line="496">
</span><span data-line="497">        <span class="n">CERTS_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="498">        <span class="n">out_file</span> <span class="o">=</span> <span class="n">CERTS_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">.tar.age&quot;</span>
</span><span data-line="499">        <span class="n">age</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;--encrypt&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="500">        <span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
</span><span data-line="501">            <span class="n">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">recipient</span><span class="p">)</span>
</span><span data-line="502">        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
</span><span data-line="503">            <span class="n">tar_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
</span><span data-line="504">            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_path</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
</span><span data-line="505">                <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fullchain</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s2">&quot;fullchain.pem&quot;</span><span class="p">)</span>
</span><span data-line="506">                <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">privkey</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="s2">&quot;privkey.pem&quot;</span><span class="p">)</span>
</span><span data-line="507">            <span class="n">age</span><span class="p">(</span><span class="n">tar_path</span><span class="p">)</span>
</span><span data-line="508">        <span class="n">chown</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;chown&quot;</span><span class="p">,</span> <span class="s2">&quot;pages:pages&quot;</span><span class="p">)</span>
</span><span data-line="509">        <span class="n">chown</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
</span><span data-line="510">
</span><span data-line="511">        <span class="n">infra_git</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span>
</span><span data-line="512">            <span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;--git-dir&quot;</span><span class="p">,</span> <span class="n">PAGES_HOME</span> <span class="o">/</span> <span class="s2">&quot;infra.git&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span data-line="513">        <span class="p">)</span><span class="o">.</span><span class="n">runuser</span><span class="p">(</span><span class="s2">&quot;pages&quot;</span><span class="p">)</span>
</span><span data-line="514">        <span class="n">git</span> <span class="o">=</span> <span class="n">infra_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;--work-tree&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">INFRA_DIR</span><span class="p">)</span>
</span><span data-line="515">        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;checkout&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
</span><span data-line="516">        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="s2">&quot;-A&quot;</span><span class="p">,</span> <span class="n">CERTS_DIR</span><span class="p">)</span>
</span><span data-line="517">        <span class="k">if</span> <span class="n">git</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;--cached&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="518">            <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="519">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_git_user</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">runuser</span><span class="p">(</span><span class="s2">&quot;pages&quot;</span><span class="p">))</span>
</span><span data-line="520">        <span class="n">git</span><span class="p">(</span><span class="s2">&quot;commit&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;Update certs&quot;</span><span class="p">)</span>
</span><span data-line="521">
</span><span data-line="522">        <span class="n">push_infra</span> <span class="o">=</span> <span class="n">infra_git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;push&quot;</span><span class="p">)</span>
</span><span data-line="523">        <span class="k">for</span> <span class="n">remote</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">Mirror</span><span class="p">()</span><span class="o">.</span><span class="n">non_primary</span><span class="p">():</span>
</span><span data-line="524">            <span class="n">push_infra</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
</span><span data-line="525">        <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="526">
</span><span data-line="527">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_git_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">git</span><span class="p">:</span> <span class="n">Command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="528">        <span class="n">conf</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">subcommand</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;--global&quot;</span><span class="p">)</span>
</span><span data-line="529">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;user.email&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="530">            <span class="n">conf</span><span class="p">(</span><span class="s2">&quot;user.email&quot;</span><span class="p">,</span> <span class="s2">&quot;pages@demin.dev&quot;</span><span class="p">)</span>
</span><span data-line="531">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;user.name&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="532">            <span class="n">conf</span><span class="p">(</span><span class="s2">&quot;user.name&quot;</span><span class="p">,</span> <span class="s2">&quot;Mr Pages&quot;</span><span class="p">)</span>
</span><span data-line="533">
</span><span data-line="534">
</span><span data-line="535"><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="536">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s2">&quot;infra&quot;</span><span class="p">)</span>
</span><span data-line="537">    <span class="n">sub</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="538">    <span class="n">ApplyCommand</span><span class="p">()</span><span class="o">.</span><span class="n">add_subparser</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span data-line="539">    <span class="n">BuilderPublishCommand</span><span class="p">()</span><span class="o">.</span><span class="n">add_subparser</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span data-line="540">    <span class="n">DistributeChallengeCommand</span><span class="p">()</span><span class="o">.</span><span class="n">add_subparser</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span data-line="541">    <span class="n">CleanupChallengeCommand</span><span class="p">()</span><span class="o">.</span><span class="n">add_subparser</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span data-line="542">    <span class="n">DistributeCertsCommand</span><span class="p">()</span><span class="o">.</span><span class="n">add_subparser</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
</span><span data-line="543">
</span><span data-line="544">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span data-line="545">    <span class="k">return</span> <span class="n">args</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span data-line="546">
</span><span data-line="547">
</span><span data-line="548"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span data-line="549">    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></pre></div>
</div>
</section>
<section id="certificate-hell">
<h2>Certificate Hell<a class="headerlink" href="#certificate-hell" title="Link to this heading">¶</a></h2>
<p>Then I deployed another mirror to https://mirror.demin.dev under a separate Google Cloud Platform account.</p>
</section>
<section id="infra-repo">
<h2>Infra Repo<a class="headerlink" href="#infra-repo" title="Link to this heading">¶</a></h2>
<p>I keep infra state in a separate bare repo on each mirror (<code class="docutils literal notranslate"><span class="pre">infra.git</span></code>).
It carries operational config and runtime data:</p>
<ol class="arabic simple">
<li><p>Builder and primary public keys (<code class="docutils literal notranslate"><span class="pre">infra/keys/builder.pub</span></code>, <code class="docutils literal notranslate"><span class="pre">infra/keys/primary.pub</span></code>).</p></li>
<li><p>Mirror public keys for encryption (<code class="docutils literal notranslate"><span class="pre">infra/keys/*.pub</span></code>).</p></li>
<li><p>Mirror list (<code class="docutils literal notranslate"><span class="pre">infra/mirrors.txt</span></code>).</p></li>
<li><p>ACME challenges (<code class="docutils literal notranslate"><span class="pre">infra/challenges/*</span></code>).</p></li>
<li><p>Encrypted cert bundles (<code class="docutils literal notranslate"><span class="pre">infra/certs/*.tar.age</span></code>).</p></li>
</ol>
<p>Mirrors check out <code class="docutils literal notranslate"><span class="pre">master</span></code> from <code class="docutils literal notranslate"><span class="pre">pages.git</span></code> into <code class="docutils literal notranslate"><span class="pre">/var/www/pages</span></code> and
<code class="docutils literal notranslate"><span class="pre">master</span></code> from <code class="docutils literal notranslate"><span class="pre">infra.git</span></code> into <code class="docutils literal notranslate"><span class="pre">/var/lib/infra</span></code>.
A systemd <code class="docutils literal notranslate"><span class="pre">.path</span></code> unit watches <code class="docutils literal notranslate"><span class="pre">/var/lib/infra</span></code> and runs <code class="docutils literal notranslate"><span class="pre">infra</span> <span class="pre">apply</span></code>
(a tiny Python CLI in <code class="docutils literal notranslate"><span class="pre">infra/cli.py</span></code>) as root on every change.</p>
<p>The builder VM pushes content to all mirrors listed in <code class="docutils literal notranslate"><span class="pre">infra/mirrors.txt</span></code>
as part of the publish step. Infra data is handled by the primary mirror.
Separately, the source repo is forwarded to the destinations listed in
<code class="docutils literal notranslate"><span class="pre">infra/forward.txt</span></code>.</p>
</section>
<section id="certificates-and-challenges">
<h2>Certificates and Challenges<a class="headerlink" href="#certificates-and-challenges" title="Link to this heading">¶</a></h2>
<p>DNS-01 is not available to me, so I do HTTP-01 with challenge distribution.
The primary mirror runs certbot with manual hooks:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">infra</span> <span class="pre">distribute-challenge</span></code> writes the token under <code class="docutils literal notranslate"><span class="pre">infra/challenges/</span></code>
and pushes the infra repo to mirrors.</p></li>
<li><p>Mirrors apply the change and copy the token into
<code class="docutils literal notranslate"><span class="pre">/var/www/pages/.well-known/acme-challenge/</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">infra</span> <span class="pre">cleanup-challenge</span></code> removes the token and pushes again.</p></li>
</ol>
<p>Certificates are distributed via the same infra repo, but encrypted.
The primary packs <code class="docutils literal notranslate"><span class="pre">fullchain.pem</span></code> and <code class="docutils literal notranslate"><span class="pre">privkey.pem</span></code> into a tarball,
encrypts it with <code class="docutils literal notranslate"><span class="pre">age</span></code> for all mirror SSH public keys,
commits to <code class="docutils literal notranslate"><span class="pre">infra/certs/</span></code>, and pushes to mirrors.
Each mirror decrypts and installs the certs during <code class="docutils literal notranslate"><span class="pre">infra</span> <span class="pre">apply</span></code>
and reloads nginx.</p>
</section>
</section>

        </article>
        <button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button>
        <div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="81-fedup.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">FedUp - Minimal Federated CDN</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="../17_notes/01_xapo.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Decentralizing the Practice of Architecture at Xapo Bank</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2022, Peter Demin</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script></body>
</html>