<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Building this Website on Git Push - Peter Demin</title><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Decentralizing the Practice of Architecture at Xapo Bank" href="../17_notes/01_xapo.html" /><link rel="prev" title="FedUp - Minimal Federated CDN" href="81-fedup.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=51f15f49" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="Building this Website on Git Push"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      
      
      <strong>Peter Demin</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#preface">Preface</a></li>
<li><a class="reference internal" href="#virtual-machine">Virtual Machine</a></li>
</ul>
</div><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/peterdemin/peterdemin.github.io"
  data-type="github" data-user="peterdemin" data-repo="peterdemin.github.io">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </span>
  <span class="flex-grow px-2 break-all">
    
    
      <span>peterdemin.github.io</span>
    
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <iconify-icon icon="lucide:star"></iconify-icon>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <iconify-icon icon="lucide:git-fork"></iconify-icon>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div class="edit-this-page">
  <a href="https://github.com/peterdemin/peterdemin.github.io/blob/master/source/12_articles/82-build-on-push.md">Edit this page</a>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="w-full max-sm:max-w-full print:pt-6">
    
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Peter Demin</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Building this Website on Git Push</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <div class="copy-page-wrapper relative pb-4 lg:absolute lg:top-8 lg:right-6 xl:right-12">
  <div id="copy-page-trigger">
    <button
      type="button"
      class="js-copy px-3 py-1 inline-flex items-center gap-1"
      data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt"
    >
      <i class="i-lucide" data-icon="copy"></i>
      <span>Copy page</span>
    </button>
    <button class="js-menu px-2 py-1" type="button" aria-label="More actions"
      aria-haspopup="menu" aria-expanded="false" aria-controls="copy-page-content">
      <i class="i-lucide chevron-down"></i>
    </button>
  </div>
  <div id="copy-page-content" role="menu" aria-orientation="vertical" aria-hidden="true">
    <div role="presentation">
      <div class="flex flex-col" role="group">
        <button class="js-copy" type="button" role="menuitem"
          data-url="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt">
          <span class="iconify-icon">
            <i class="i-lucide" data-icon="copy"></i>
          </span>
          <span>Copy page</span>
        </button>
        <a role="menuitem" href="https://raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt" target="_blank" rel="nofollow"><iconify-icon icon="bi:markdown"></iconify-icon>
            <span>View as Markdown</span></a><a role="menuitem" href="https://chatgpt.com/?hints=search&q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:openai"></iconify-icon>
          <span>Open in ChatGPT</span>
        </a><a role="menuitem" href="https://claude.ai/new?q=Read%20https%3A//raw.githubusercontent.com/peterdemin/peterdemin.github.io/refs/heads/master/source/12_articles/82-build-on-push.md.txt%20so%20I%20can%20ask%20questions%20about%20it." target="_blank" rel="nofollow">
          <iconify-icon icon="bi:claude"></iconify-icon>
          <span>Open in Claude</span>
        </a></div>
    </div>
  </div>
</div><article class="yue" role="main">
          <section id="building-this-website-on-git-push">
<h1>Building this Website on Git Push<a class="headerlink" href="#building-this-website-on-git-push" title="Link to this heading">¶</a></h1>
<section id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Link to this heading">¶</a></h2>
<p>In the spirit of my recent fascination with self-sovereignity and decentralization I will replace the fancy friendly mature reliable GitHub Pages with a hack.</p>
<blockquote>
<div><p>As a side note, I like GitHub Pages, the service democratized static website hosting and made it easily approachable to many developers.
GitHub Actions allow flexible builds outside of the default Jekyll system.
For example, I’m using a Makefile with SphinxDocs, and quiet happy with it.
And all of it is completely free.
But this article is not about GitHub Pages, this is about an <em>alternative</em>.</p>
</div></blockquote>
<p>The hack is to run a Debian VM on my home server with a git repo and post-receive hook that builds a static website.
The built artifact is then committed to another repo, which is pushed to a Cloud VPS.
I could’ve simplified the setup by building the website directly on the VPS, the problem is that it’s so tiny, I doubt it can handle the build process.</p>
<p>The website build process got pretty involved over the years since I’m hoarding all my petty experiments for no good reason.
The builder needs Python, graphviz, NodeJS, and customary imperial tonne of npm packages.</p>
<p>I’ll keep the VM running at all times and preserve the build files so it can run incrementally.
I’ll also ship the build artifact through git, which should be much faster then a complete artifact every time.</p>
</section>
<section id="virtual-machine">
<h2>Virtual Machine<a class="headerlink" href="#virtual-machine" title="Link to this heading">¶</a></h2>
<p>My favorite way of running virtual machines is with Vagrant and KVM.</p>
<p><code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># -*- mode: ruby -*-</span>
</span><span data-line="2"><span class="c1"># vi: set ft=ruby :</span>
</span><span data-line="3">
</span><span data-line="4"><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span data-line="5"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;debian/trixie64&quot;</span>
</span><span data-line="6"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span><span class="w"> </span><span class="s2">&quot;./&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;virtiofs&quot;</span>
</span><span data-line="7"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span><span class="w"> </span><span class="ss">:libvirt</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
</span><span data-line="8"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kvm&quot;</span>
</span><span data-line="9"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;qemu:///system&#39;</span>
</span><span data-line="10"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">cpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</span><span data-line="11"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2048&quot;</span>
</span><span data-line="12"><span class="w">      </span><span class="n">libvirt</span><span class="o">.</span><span class="n">memorybacking</span><span class="w"> </span><span class="ss">:access</span><span class="p">,</span><span class="w"> </span><span class="ss">:mode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s2">&quot;shared&quot;</span>
</span><span data-line="13"><span class="w">    </span><span class="k">end</span>
</span><span data-line="14"><span class="w">    </span><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span><span class="w"> </span><span class="s2">&quot;shell&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;provision_builder.sh&quot;</span>
</span><span data-line="15"><span class="k">end</span>
</span></pre></div>
</div>
<p>Upon creation (<code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code>) it immediately runs the provisioning script that sets everything up.
The script is reentrant, because I had to iterate a bit to polish all the kinks.</p>
<p><code class="docutils literal notranslate"><span class="pre">provision_builder.sh</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="ch">#!/bin/bash</span>
</span><span data-line="2"><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</span><span data-line="3">
</span><span data-line="4">apt-get<span class="w"> </span>update
</span><span data-line="5">apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w">      </span><span class="se">\</span>
</span><span data-line="6"><span class="w">    </span>curl<span class="w">                </span><span class="se">\</span>
</span><span data-line="7"><span class="w">    </span>build-essential<span class="w">     </span><span class="se">\</span>
</span><span data-line="8"><span class="w">    </span>git<span class="w">                 </span><span class="se">\</span>
</span><span data-line="9"><span class="w">    </span>python3-venv<span class="w">        </span><span class="se">\</span>
</span><span data-line="10"><span class="w">    </span>python-is-python3<span class="w">   </span><span class="se">\</span>
</span><span data-line="11"><span class="w">    </span>graphviz<span class="w">            </span><span class="se">\</span>
</span><span data-line="12"><span class="w">    </span>nodejs<span class="w">              </span><span class="se">\</span>
</span><span data-line="13"><span class="w">    </span>npm<span class="w">                 </span><span class="se">\</span>
</span><span data-line="14"><span class="w">    </span>rsync
</span><span data-line="15">
</span><span data-line="16">tailscale<span class="w"> </span>status<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="se">\</span>
</span><span data-line="17"><span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/apt/keyrings<span class="w"> </span><span class="se">\</span>
</span><span data-line="18"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg<span class="w"> </span>&gt;<span class="w"> </span>/usr/share/keyrings/tailscale-archive-keyring.gpg<span class="w"> </span><span class="se">\</span>
</span><span data-line="19"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list<span class="w"> </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/tailscale.list<span class="w"> </span><span class="se">\</span>
</span><span data-line="20"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="se">\</span>
</span><span data-line="21"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>tailscale<span class="w"> </span><span class="se">\</span>
</span><span data-line="22"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>tailscale<span class="w"> </span>login<span class="w"> </span><span class="se">\</span>
</span><span data-line="23"><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>tailscale<span class="w"> </span>up<span class="w"> </span><span class="se">\</span>
</span><span data-line="24"><span class="o">)</span>
</span><span data-line="25">
</span><span data-line="26">id<span class="w"> </span>builder<span class="w"> </span><span class="o">||</span><span class="w"> </span>useradd<span class="w"> </span>-rms<span class="w"> </span>/usr/bin/git-shell<span class="w"> </span>builder
</span><span data-line="27">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~builder/.ssh
</span><span data-line="28">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>/var/www/site
</span><span data-line="29">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0600</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~builder/.ssh/authorized_keys<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="30"><span class="s">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDYxOnUHnt2KZ8kdjYjO/xWflaFKxXXJLv6V8/TiXgow8L+QdFmcEJ/NRdR6/LVLEwiJ5h9l26mY8XxlpVAIY43NqbhPUdBp6SoeX2tpHFQa4R1i7coO3bO1sjAVqeTmTby4iROtWZ89OEsqYnWyYco4py+sn6X+h8TDRIbrl2zYQI9IwK8O2UJTV9qT2Vy4s4fitLTeO6AI7935OsrLzXV+iaGGmhoUfpZcHZ5I9puaaTOyxuJ3q4nA0PNiZ9Lw7+TYOo73eXPA+qRrsvEy6b6x3+izyj4WX31YSklksw5CX+jjc23d7muV8cHFaoO1GkueVYyve8ncqy0dGn9CiDQudVqUyhqkF49MvWO1Hjg9SeidaKGqalh0Pv8RJquTJ8aUXcVS9GwCmYu+/JfBVcCGYKEpcwrLOt/iYa9iHCsImb/wlO08n3R+HBIF4At0Jxgd4wWM8ZhSXoA2UjCBojZwcWLPuS+S/zplFgi3stv+mkfEf9WDQo1g5bueFJ+gK8= peterdemin@MBA</span>
</span><span data-line="31"><span class="s">EOF</span>
</span><span data-line="32"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/repo.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~builder/repo.git&quot;</span>
</span><span data-line="33"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/pages.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~builder/pages.git &amp;&amp; git -C ~builder/pages.git remote add origin pages@demin-dev.tail13c89.ts.net:repo.git &amp;&amp; git -C ~builder/pages.git remote add mirror pages@mirror.tail13c89.ts.net:repo.git&quot;</span>
</span><span data-line="34"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~builder/venv<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;python3 -m venv ~builder/venv&quot;</span>
</span><span data-line="35"><span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>~builder/.ssh/id_ed25519<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -t ed25519 -f ~builder/.ssh/id_ed25519 -N &quot;&quot;&#39;</span>
</span><span data-line="36"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Copy public key to serving host:&quot;</span>
</span><span data-line="37">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keygen -yf ~builder/.ssh/id_ed25519&#39;</span>
</span><span data-line="38"><span class="nb">echo</span>
</span><span data-line="39">
</span><span data-line="40">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global user.email &quot;builder@demin.dev&quot;&#39;</span>
</span><span data-line="41">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global user.name &quot;Builder Bot&quot;&#39;</span>
</span><span data-line="42">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;git config --global init.defaultBranch master&#39;</span>
</span><span data-line="43">sudo<span class="w"> </span>-u<span class="w"> </span>builder<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;ssh-keyscan -t ed25519 demin-dev.tail13c89.ts.net &gt; ~/.ssh/known_hosts&#39;</span>
</span><span data-line="44">
</span><span data-line="45">install<span class="w"> </span>-o<span class="w"> </span>builder<span class="w"> </span>-g<span class="w"> </span>builder<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~builder/worktree
</span><span data-line="46">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~builder/repo.git/hooks/post-receive<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="47"><span class="s">#!/usr/bin/env bash</span>
</span><span data-line="48"><span class="s">set -euo pipefail</span>
</span><span data-line="49">
</span><span data-line="50"><span class="s">HOME=/home/builder</span>
</span><span data-line="51"><span class="s">WORK_TREE=&quot;$HOME/worktree&quot;</span>
</span><span data-line="52"><span class="s">LIVE_DIR=&quot;/var/www/site&quot;</span>
</span><span data-line="53">
</span><span data-line="54"><span class="s">BRANCH=&quot;master&quot;</span>
</span><span data-line="55"><span class="s">BRANCH_REF=&quot;refs/heads/$BRANCH&quot;</span>
</span><span data-line="56">
</span><span data-line="57"><span class="s">read oldrev newrev REFNAME</span>
</span><span data-line="58"><span class="s">if [[ &quot;$REFNAME&quot; != &quot;$BRANCH_REF&quot; ]]; then</span>
</span><span data-line="59"><span class="s">  echo &quot;Ignoring push to $REFNAME (only deploys $BRANCH_REF)&quot;</span>
</span><span data-line="60"><span class="s">  exit 0</span>
</span><span data-line="61"><span class="s">fi</span>
</span><span data-line="62">
</span><span data-line="63"><span class="s">git --git-dir=&quot;$HOME/repo.git&quot; --work-tree=&quot;$WORK_TREE&quot; checkout -f $BRANCH</span>
</span><span data-line="64">
</span><span data-line="65"><span class="s">cd &quot;$WORK_TREE&quot;</span>
</span><span data-line="66"><span class="s">. $HOME/venv/bin/activate</span>
</span><span data-line="67"><span class="s">make install lightweight compress pages</span>
</span><span data-line="68"><span class="s">EOF</span>
</span></pre></div>
</div>
<p>And that’s how I cut my website publish time from 5 minutes down to 10 seconds.</p>
<p>Setting up the serving host is similar, except that instead of building it just needs to check out.</p>
<p><code class="docutils literal notranslate"><span class="pre">provision_pages.sh</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="ch">#!/bin/bash</span>
</span><span data-line="2"><span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail
</span><span data-line="3">
</span><span data-line="4"><span class="nv">EMAIL</span><span class="o">=</span>peter@demin.dev
</span><span data-line="5">
</span><span data-line="6">apt-mark<span class="w"> </span>hold<span class="w"> </span>google-cloud-cli<span class="w"> </span>google-cloud-cli-anthoscli<span class="w"> </span>google-guest-agent<span class="w"> </span>google-osconfig-agent
</span><span data-line="7">
</span><span data-line="8">mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/apt/keyrings
</span><span data-line="9">curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.noarmor.gpg<span class="w"> </span>&gt;<span class="w"> </span>/usr/share/keyrings/tailscale-archive-keyring.gpg
</span><span data-line="10">curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pkgs.tailscale.com/stable/debian/trixie.tailscale-keyring.list<span class="w"> </span>&gt;<span class="w"> </span>/etc/apt/sources.list.d/tailscale.list
</span><span data-line="11">
</span><span data-line="12">apt-get<span class="w"> </span>update
</span><span data-line="13">apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w">      </span><span class="se">\</span>
</span><span data-line="14"><span class="w">    </span>ca-certificates<span class="w">     </span><span class="se">\</span>
</span><span data-line="15"><span class="w">    </span>screen<span class="w">              </span><span class="se">\</span>
</span><span data-line="16"><span class="w">    </span>lsof<span class="w">                </span><span class="se">\</span>
</span><span data-line="17"><span class="w">    </span>python3-venv<span class="w">        </span><span class="se">\</span>
</span><span data-line="18"><span class="w">    </span>python-is-python3<span class="w">   </span><span class="se">\</span>
</span><span data-line="19"><span class="w">    </span>nginx<span class="w">               </span><span class="se">\</span>
</span><span data-line="20"><span class="w">    </span>git<span class="w">                 </span><span class="se">\</span>
</span><span data-line="21"><span class="w">    </span>tailscale
</span><span data-line="22">
</span><span data-line="23">tailscale<span class="w"> </span>status<span class="w"> </span><span class="o">||</span><span class="w"> </span>tailscale<span class="w"> </span>login
</span><span data-line="24">
</span><span data-line="25"><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-e<span class="w"> </span>/usr/bin/certbot<span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span data-line="26"><span class="w">    </span>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>/opt/certbot/
</span><span data-line="27"><span class="w">    </span>/opt/certbot/bin/python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>certbot<span class="w"> </span>certbot-nginx
</span><span data-line="28"><span class="w">    </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/certbot/bin/certbot<span class="w"> </span>/usr/bin/certbot
</span><span data-line="29"><span class="k">fi</span>
</span><span data-line="30">
</span><span data-line="31">id<span class="w"> </span>pages<span class="w"> </span><span class="o">||</span><span class="w"> </span>useradd<span class="w"> </span>-rms<span class="w"> </span>/usr/bin/git-shell<span class="w"> </span>pages
</span><span data-line="32">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>pages<span class="w"> </span>-m<span class="w"> </span><span class="m">0700</span><span class="w"> </span>-d<span class="w"> </span>~pages/.ssh
</span><span data-line="33">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>www-data<span class="w"> </span>-m<span class="w"> </span><span class="m">0750</span><span class="w"> </span>-d<span class="w"> </span>/var/www/pages
</span><span data-line="34">install<span class="w"> </span>-o<span class="w"> </span>pages<span class="w"> </span>-g<span class="w"> </span>pages<span class="w"> </span>-m<span class="w"> </span><span class="m">0600</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~pages/.ssh/authorized_keys<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="35"><span class="s">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILG64GMcBIxl4rGuRum2n07Kf7dE9CUlzLl84e/TWvTM builder@trixie</span>
</span><span data-line="36"><span class="s">EOF</span>
</span><span data-line="37"><span class="nb">test</span><span class="w"> </span>-d<span class="w"> </span>~pages/repo.git<span class="w"> </span><span class="o">||</span><span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>pages<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;git init --bare ~pages/repo.git&quot;</span>
</span><span data-line="38">install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>/dev/stdin<span class="w"> </span>~pages/repo.git/hooks/post-receive<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="39"><span class="s">#!/usr/bin/env bash</span>
</span><span data-line="40"><span class="s">set -euo pipefail</span>
</span><span data-line="41">
</span><span data-line="42"><span class="s">git --git-dir=&quot;/home/pages/repo.git&quot; --work-tree=&quot;/var/www/pages&quot; checkout -f master</span>
</span><span data-line="43"><span class="s">EOF</span>
</span><span data-line="44">
</span><span data-line="45"><span class="c1"># 8&lt; - - - - - Abort if nginx config already exist - - - - -</span>
</span><span data-line="46"><span class="nb">test</span><span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
</span><span data-line="47">
</span><span data-line="48">rm<span class="w"> </span>-f<span class="w"> </span>/etc/nginx/sites-enabled/default
</span><span data-line="49">cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span><span class="s">&lt;&lt;&#39;EOF&#39;</span>
</span><span data-line="50"><span class="s">server {</span>
</span><span data-line="51"><span class="s">    server_name mirror.demin.dev;</span>
</span><span data-line="52"><span class="s">    root /var/www/pages;</span>
</span><span data-line="53"><span class="s">    index index.html index.htm;</span>
</span><span data-line="54"><span class="s">    location / {</span>
</span><span data-line="55"><span class="s">		gzip_static on;</span>
</span><span data-line="56"><span class="s">        try_files $uri $uri/ =404;</span>
</span><span data-line="57"><span class="s">    }</span>
</span><span data-line="58"><span class="s">}</span>
</span><span data-line="59"><span class="s">EOF</span>
</span><span data-line="60">ln<span class="w"> </span>-fs<span class="w"> </span>/etc/nginx/sites-available/pages<span class="w"> </span>/etc/nginx/sites-enabled/pages
</span><span data-line="61">certbot<span class="w"> </span>--agree-tos<span class="w"> </span>--nginx<span class="w"> </span>-m<span class="w"> </span>peter@demin.dev<span class="w"> </span>--non-interactive<span class="w"> </span>-d<span class="w"> </span>mirror.demin.dev
</span><span data-line="62">systemctl<span class="w"> </span>restart<span class="w"> </span>nginx.service
</span><span data-line="63">
</span><span data-line="64">screen<span class="w"> </span>-dm<span class="w"> </span>/bin/sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;apt remove --allow-change-held-packages -y google-cloud-cli google-cloud-cli-anthoscli google-guest-agent google-osconfig-agent&quot;</span>
</span></pre></div>
</div>
<p>I added a flag to nginx to serve static precompressed gzip files to save CPU on the serving side.</p>
<p>Then I deployed another mirror to https://mirror.demin.dev under a separate Google Cloud Platform account.</p>
</section>
</section>

        </article>
        <button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button>
        <div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="81-fedup.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">FedUp - Minimal Federated CDN</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="../17_notes/01_xapo.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Decentralizing the Practice of Architecture at Xapo Bank</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2022, Peter Demin</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/shibuya.js?v=cac61aee"></script></body>
</html>