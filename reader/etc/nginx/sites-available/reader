upstream reader {
    server unix:/run/reader/reader.sock;
}

server {
    server_name reader.demin.dev;
    client_max_body_size 10m;
    root /var/www/reader;
    index index.html;
    gzip_static on;

    location = /api/render {
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        add_header Access-Control-Max-Age 86400 always;
        return 204;
      }

      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

      proxy_pass http://reader;
      proxy_http_version 1.0;
      proxy_set_header Connection "close";
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header Host $http_host;
      proxy_read_timeout 30s;
      proxy_send_timeout 30s;
    }

    location = /healthz {
      proxy_pass http://reader;
      proxy_http_version 1.0;
      proxy_set_header Connection "close";
      proxy_set_header Host $http_host;
    }

    location ^~ /p/ {
      try_files $uri =404;
    }

    location / {
      try_files $uri $uri/ /index.html;
    }
}
