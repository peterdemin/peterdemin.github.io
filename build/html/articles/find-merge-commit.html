
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to find merge commit which includes a specific commit &#8212; Peter Demin  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to clean up stale git branches" href="git-branch-cleanup.html" />
    <link rel="prev" title="MSSQL cheatsheet" href="create-mssql-user.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">Peter Demin</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
    </div>

    <div id="navbar-end">
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scripting-the-solution">
   Scripting the solution
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="how-to-find-merge-commit-which-includes-a-specific-commit">
<h1>How to find merge commit which includes a specific commit<a class="headerlink" href="#how-to-find-merge-commit-which-includes-a-specific-commit" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p>TL;DR in the end you can find git alias config, that will just do the thing.</p>
</div></blockquote>
<p>Recently I was researching how a complex feature was implemented.
I found in <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">log</span> <span class="pre">-p</span></code> output commit, that did a part of it, but I needed a big picture.
We use BitBucket’s pull request for review, and naturally all links and discussions aggregate there,
so I wanted to find a PR, that had a specific change.</p>
<p>If presented in terms of git commits graph we have something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="n">c</span><span class="o">---</span><span class="n">e</span><span class="o">---</span><span class="n">g</span>    <span class="n">feature</span>
      <span class="o">/</span>         \
<span class="o">-</span><span class="n">a</span><span class="o">---</span><span class="n">b</span><span class="o">---</span><span class="n">d</span><span class="o">---</span><span class="n">f</span><span class="o">---</span><span class="n">h</span><span class="o">---</span><span class="n">i</span><span class="o">---</span><span class="n">j</span><span class="o">---</span> <span class="n">master</span>
</pre></div>
</div>
<p>I know the commit hash for <code class="docutils literal notranslate"><span class="pre">c</span></code> and want to find commit <code class="docutils literal notranslate"><span class="pre">h</span></code> that has PR number in it’s message.</p>
<p>Unfortunately git doesn’t provide a builtin command for such case.
But it has <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rev-list</span></code> - the tool, that lists commit hashes with a bunch of different options.</p>
<p>First option of interest is <code class="docutils literal notranslate"><span class="pre">--ancestry-path</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">--</span><span class="n">ancestry</span><span class="o">-</span><span class="n">path</span>
     <span class="n">When</span> <span class="n">given</span> <span class="n">a</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">commits</span> <span class="n">to</span> <span class="n">display</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>  <span class="n">commit1</span><span class="o">..</span><span class="n">commit2</span> <span class="ow">or</span> <span class="n">commit2</span> <span class="o">^</span><span class="n">commit1</span><span class="p">),</span>
     <span class="n">only</span> <span class="n">display</span> <span class="n">commits</span> <span class="n">that</span> <span class="n">exist</span> <span class="n">directly</span> <span class="n">on</span> <span class="n">the</span> <span class="n">ancestry</span> <span class="n">chain</span> <span class="n">between</span> <span class="n">the</span> <span class="n">commit1</span> <span class="ow">and</span> <span class="n">commit2</span><span class="p">,</span>
     <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">commits</span> <span class="n">that</span> <span class="n">are</span> <span class="n">both</span> <span class="n">descendants</span> <span class="n">of</span> <span class="n">commit1</span><span class="p">,</span> <span class="ow">and</span> <span class="n">ancestors</span> <span class="n">of</span> <span class="n">commit2</span><span class="o">.</span>
</pre></div>
</div>
<p>So for command <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rev-list</span> <span class="pre">--ancestry-path</span> <span class="pre">c..master</span></code> it will give the list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span> <span class="n">i</span> <span class="n">h</span> <span class="n">g</span> <span class="n">e</span>
</pre></div>
</div>
<p>This list includes all feature commits and all the commits that were done in master after the merge.
It doesn’t include all the commits on master that were done prior the <code class="docutils literal notranslate"><span class="pre">h</span></code> merge (<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">b</span> <span class="pre">d</span> <span class="pre">f</span></code>).</p>
<p>Now I need to remove the tail, which is <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">j</span></code>.
I’ll do it with the help of <code class="docutils literal notranslate"><span class="pre">--first-parent</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">--</span><span class="n">first</span><span class="o">-</span><span class="n">parent</span>
     <span class="n">Follow</span> <span class="n">only</span> <span class="n">the</span> <span class="n">first</span> <span class="n">parent</span> <span class="n">commit</span> <span class="n">upon</span> <span class="n">seeing</span> <span class="n">a</span> <span class="n">merge</span> <span class="n">commit</span><span class="o">.</span>
     <span class="n">This</span> <span class="n">option</span> <span class="n">can</span> <span class="n">give</span> <span class="n">a</span> <span class="n">better</span> <span class="n">overview</span> <span class="n">when</span> <span class="n">viewing</span> <span class="n">the</span> <span class="n">evolution</span> <span class="n">of</span> <span class="n">a</span> <span class="n">particular</span> <span class="n">topic</span> <span class="n">branch</span><span class="p">,</span>
     <span class="n">because</span> <span class="n">merges</span> <span class="n">into</span> <span class="n">a</span> <span class="n">topic</span> <span class="n">branch</span> <span class="n">tend</span> <span class="n">to</span> <span class="n">be</span> <span class="n">only</span> <span class="n">about</span> <span class="n">adjusting</span> <span class="n">to</span> <span class="n">updated</span> <span class="n">upstream</span>
     <span class="kn">from</span> <span class="nn">time</span> <span class="n">to</span> <span class="n">time</span><span class="p">,</span> <span class="ow">and</span> <span class="n">this</span> <span class="n">option</span> <span class="n">allows</span> <span class="n">you</span> <span class="n">to</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">individual</span> <span class="n">commits</span>
     <span class="n">brought</span> <span class="ow">in</span> <span class="n">to</span> <span class="n">your</span> <span class="n">history</span> <span class="n">by</span> <span class="n">such</span> <span class="n">a</span> <span class="n">merge</span><span class="o">.</span> <span class="n">Cannot</span> <span class="n">be</span> <span class="n">combined</span> <span class="k">with</span> <span class="o">--</span><span class="n">bisect</span><span class="o">.</span>
</pre></div>
</div>
<p>Command <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">rev-list</span> <span class="pre">--first-parent</span> <span class="pre">c..master</span></code> will return list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span> <span class="n">i</span> <span class="n">h</span> <span class="n">f</span> <span class="n">d</span> <span class="n">b</span> <span class="n">a</span>
</pre></div>
</div>
<p>That is, history of master branch, that excludes commits on feature branch.
If we look closer on two lists at hand, we’ll see, that they start the same and go different paths exactly on the <code class="docutils literal notranslate"><span class="pre">h</span></code> commit.
So now I need to compare two lists and the find first different item. Sounds easy, not so easy to do in bash.</p>
<p>First let’s add line numbers to the output of these two commands. Like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ (git rev-list --ancestry-path c..master | cat -n); (git rev-list --first-parent c..master | cat -n)
1 j
2 i
3 h
4 g
5 e
1 j
2 i
3 h
4 f
5 d
6 b
7 a
</pre></div>
</div>
<p>Then sort them by commit hash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">k2</span> <span class="o">-</span><span class="n">s</span>
<span class="mi">7</span> <span class="n">a</span>
<span class="mi">6</span> <span class="n">b</span>
<span class="mi">5</span> <span class="n">d</span>
<span class="mi">5</span> <span class="n">e</span>
<span class="mi">4</span> <span class="n">f</span>
<span class="mi">4</span> <span class="n">g</span>
<span class="mi">3</span> <span class="n">h</span>
<span class="mi">3</span> <span class="n">h</span>
<span class="mi">2</span> <span class="n">i</span>
<span class="mi">2</span> <span class="n">i</span>
<span class="mi">1</span> <span class="n">j</span>
<span class="mi">1</span> <span class="n">j</span>
</pre></div>
</div>
<p>Here we can clearly see that duplication starts at <code class="docutils literal notranslate"><span class="pre">h</span></code>. Let’s remove all unique commits leaving only duplicates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="o">|</span> <span class="n">uniq</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">f1</span>
<span class="mi">3</span> <span class="n">h</span>
<span class="mi">2</span> <span class="n">i</span>
<span class="mi">1</span> <span class="n">j</span>
</pre></div>
</div>
<p>Example output is in order, so I can just grab the first line.
But that’s true for this simplistic example and not likely with real hashes.
And it is exactly the reason behind adding line numbers.
After numeric sort:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="o">|</span> <span class="n">sort</span> <span class="o">-</span><span class="n">n</span>
<span class="mi">1</span> <span class="n">j</span>
<span class="mi">2</span> <span class="n">i</span>
<span class="mi">3</span> <span class="n">h</span>
</pre></div>
</div>
<p>Now take the last line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="o">|</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">1</span>
<span class="mi">3</span> <span class="n">h</span>
</pre></div>
</div>
<p>And strip the line number, leaving the commit hash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">f2</span>
<span class="n">h</span>
</pre></div>
</div>
<p>Having this hash, I was able to (finally) read the commit message and see the pull request number:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">show</span> <span class="n">h</span>

<span class="n">Merge</span> <span class="n">pull</span> <span class="n">request</span> <span class="c1">#415 in repo from feature to master</span>
</pre></div>
</div>
<section id="scripting-the-solution">
<h2>Scripting the solution<a class="headerlink" href="#scripting-the-solution" title="Permalink to this headline">#</a></h2>
<p>Add these lines to your git config file (user specific <code class="docutils literal notranslate"><span class="pre">~/.gitconfig</span></code> or repo specific <code class="docutils literal notranslate"><span class="pre">.git/config</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
    <span class="n">find</span><span class="o">-</span><span class="n">merge</span> <span class="o">=</span> <span class="s2">&quot;!sh -c &#39;commit=$0 &amp;&amp; branch=${1:-HEAD} &amp;&amp; (git rev-list $commit..$branch --ancestry-path | cat -n; git rev-list $commit..$branch --first-parent | cat -n) | sort -k2 -s | uniq -f1 -d | sort -n | tail -1 | cut -f2&#39;&quot;</span>
    <span class="n">show</span><span class="o">-</span><span class="n">merge</span> <span class="o">=</span> <span class="s2">&quot;!sh -c &#39;merge=$(git find-merge $0 $1) &amp;&amp; [ -n </span><span class="se">\&quot;</span><span class="s2">$merge</span><span class="se">\&quot;</span><span class="s2"> ] &amp;&amp; git show $merge&#39;&quot;</span>
</pre></div>
</div>
<p>Credits to <a class="reference external" href="https://stackoverflow.com/users/305973/robinst">Robin Stocker</a> who came up with the solution in <a class="reference external" href="https://stackoverflow.com/a/30998048/135079">this StackOverflow question</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="create-mssql-user.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">MSSQL cheatsheet</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="git-branch-cleanup.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How to clean up stale git branches</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, Peter Demin.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>